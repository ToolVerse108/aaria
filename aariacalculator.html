<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AARIA ‚Äî Plot Investment ROI Calculator (Mobile Friendly)</title>

<!-- html2pdf bundle for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
  :root{
    --bg:#f3f6fb;
    --card:#ffffff;
    --accent:#007bff;
    --accent-dark:#2a5298;
    --muted:#66788a;
    --radius:12px;
    --gap:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    color:#103044;
    padding:16px;
    -webkit-font-smoothing:antialiased;
  }

  .wrap{max-width:980px;margin:0 auto;background:linear-gradient(180deg,#ffffff 0,#ffffff 100%);border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(16,48,68,.08)}
  header{padding:18px 20px;border-bottom:1px solid rgba(16,48,68,.04);display:flex;gap:12px;align-items:center;flex-wrap:wrap;background:linear-gradient(90deg,var(--card),#f8fbff)}
  header h1{font-size:18px;margin:0;color:var(--accent-dark);font-weight:700}
  header p{margin:0;color:var(--muted);font-size:13px}

  .content{display:grid;grid-template-columns:1fr 430px;gap:18px;padding:18px}
  /* left column forms */
  .panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(16,48,68,.03)}
  .section-title{font-size:14px;color:var(--accent-dark);font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px}
  .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .form-row{display:flex;flex-direction:column;gap:6px}
  label{font-size:13px;color:#0b2230;font-weight:600}
  input[type=number], select{padding:10px;border-radius:8px;border:1px solid #e6edf5;background:#fbfdff;font-size:14px}
  .helper{font-size:12px;color:var(--muted)}
  .calc-btn{margin-top:12px;background:linear-gradient(90deg,var(--accent),var(--accent-dark));color:#fff;border:none;padding:12px 14px;border-radius:10px;font-weight:700;cursor:pointer;width:100%}
  .small{font-size:12px;color:var(--muted)}
  .inline{display:flex;gap:8px;align-items:center}

  /* right column results */
  .results-col{position:relative}
  .results-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px}
  .big-metric{background:linear-gradient(90deg,#fff,#fbfeff);padding:12px;border-radius:10px;box-shadow:0 6px 14px rgba(16,48,68,.03);display:flex;flex-direction:column;gap:6px}
  .big-metric .label{font-size:12px;color:var(--muted);font-weight:700}
  .big-metric .value{font-size:20px;color:var(--accent-dark);font-weight:900}
  .results-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
  .stat{background:#ffffff;padding:10px;border-radius:10px;text-align:center;box-shadow:0 6px 14px rgba(16,48,68,.03)}
  .stat .k{font-size:15px;font-weight:800;color:var(--accent-dark)}
  .stat .sub{font-size:12px;color:var(--muted)}
  .progress-wrap{background:#fff;padding:10px;border-radius:10px;margin-top:12px}
  .progress{height:18px;background:#eef5ff;border-radius:10px;overflow:hidden}
  .progress > div{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:12px}

  .timeline{background:#fff;padding:10px;border-radius:10px;margin-top:12px}
  .timeline-item{display:flex;justify-content:space-between;gap:10px;padding:8px 4px;border-bottom:1px dashed #f0f4fb}
  .timeline-item:last-child{border-bottom:none}
  .comparison{margin-top:12px;background:#fff;padding:10px;border-radius:10px}
  .insights{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
  .insight{background:#fff;padding:10px;border-radius:10px}

  /* share / download icons */
  .actions{display:flex;gap:8px;align-items:center}
  .icon-btn{display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:#f6fbff;border:1px solid #e6f0ff;color:var(--accent-dark);cursor:pointer;font-weight:700}
  .icon-btn svg{width:16px;height:16px;fill:var(--accent-dark)}

  /* modal for assumptions */
  .assumptions{font-size:13px;color:var(--muted);margin-top:10px;background:#fff;padding:10px;border-radius:10px}
  .disclaimer{font-size:12px;color:#7a2a2a;background:#fff3f3;padding:8px;border-radius:8px;margin-top:10px;border:1px solid #ffd6d6}

  /* tooltips small info */
  .info{display:inline-block;width:18px;height:18px;border-radius:50%;background:var(--accent);color:white;font-size:12px;line-height:18px;text-align:center;cursor:help}

  /* sensitivity row */
  .sensitivity{display:flex;gap:10px;align-items:center;margin-top:10px}

  /* responsive */
  @media (max-width: 900px){
    .content{grid-template-columns:1fr; padding:16px}
    .form-grid{grid-template-columns:1fr}
    .results-grid{grid-template-columns:1fr}
    .insights{grid-template-columns:1fr}
    .results-col{order:2}
  }
  /* tiny screens */
  @media (max-width:420px){
    header p{display:none}
    .big-metric .value{font-size:18px}
  }
</style>
</head>
<body>

<div class="wrap" role="main" aria-labelledby="mainTitle">
  <header>
    <div>
      <h1 id="mainTitle">AARIA ‚Äî Plot Investment ROI Calculator</h1>
      <p>Investor-ready snapshot ‚Ä¢ Mobile-first ‚Ä¢ PDF export & share</p>
    </div>
    <div style="margin-left:auto" class="small">Blue palette: #007bff / #2a5298</div>
  </header>

  <div class="content">
    <!-- LEFT: Inputs -->
    <div>
      <div class="panel" aria-label="Inputs">
        <div class="section-title">üèóÔ∏è Plot & Purchase</div>
        <div class="form-grid">
          <div class="form-row">
            <label>Purchase Price (‚Çπ) <span class="info" title="Enter actual sale-deed/agreement value">i</span></label>
            <input id="purchasePrice" type="number" value="5000000" />
            <div class="helper">Sale deed / agreement value</div>
          </div>
          <div class="form-row">
            <label>Plot Size <span class="info" title="Area in chosen unit">i</span></label>
            <input id="plotSize" type="number" value="1000" />
            <div class="helper">Area</div>
          </div>
          <div class="form-row">
            <label>Unit</label>
            <select id="plotUnit"><option value="sqft" selected>sq ft</option><option value="sqyard">sq yard</option><option value="sqmeter">sq meter</option></select>
          </div>
          <div class="form-row">
            <label>Circle Rate (‚Çπ per unit)</label>
            <input id="circleRate" type="number" value="4500" />
            <div class="helper">Govt notified guidance value</div>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div class="section-title">üí∞ Purchase Costs & Registration</div>
        <div class="form-grid">
          <div class="form-row">
            <label>State (stamp duty)</label>
            <select id="state">
              <option value="up">Uttar Pradesh (7%)</option>
              <option value="mh">Maharashtra (5.5%)</option>
              <option value="dl">Delhi (6%)</option>
              <option value="ka">Karnataka (5%)</option>
              <option value="tn">Tamil Nadu (7%)</option>
              <option value="rj">Rajasthan (5.5%)</option>
              <option value="gj">Gujarat (4.9%)</option>
              <option value="hr">Haryana (6.5%)</option>
              <option value="mp">Madhya Pradesh (7.5%)</option>
              <option value="pb">Punjab (7%)</option>
            </select>
          </div>
          <div class="form-row">
            <label>Registration Cost (‚Çπ)</label>
            <input id="registrationCost" type="number" value="10000" />
          </div>
          <div class="form-row">
            <label>GST applicable?</label>
            <select id="gstApplicable"><option value="no" selected>No</option><option value="yes">Yes</option></select>
          </div>
          <div class="form-row">
            <label>Brokerage (%)</label>
            <input id="brokerage" type="number" value="1" step="0.1" />
          </div>
          <div class="form-row">
            <label>Lawyer / Consultancy (‚Çπ)</label>
            <input id="lawyerFees" type="number" value="25000" />
          </div>
          <div class="form-row">
            <label>Other misc (‚Çπ)</label>
            <input id="miscCosts" type="number" value="10000" />
          </div>
        </div>

        <div style="margin-top:10px" class="inline small">
          <div>Price per unit: <strong id="pricePerUnit">‚Äî</strong></div>
          <div style="margin-left:12px;color:var(--muted)" id="circleRateComparison"></div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div class="section-title">üè¶ Loan & Holding</div>
        <div class="form-grid">
          <div class="form-row">
            <label>Taking Loan?</label>
            <select id="loanTaken"><option value="no" selected>No</option><option value="yes">Yes</option></select>
          </div>
          <div class="form-row">
            <label>Loan amount (‚Çπ)</label>
            <input id="loanAmount" type="number" value="3000000" />
          </div>
          <div class="form-row">
            <label>Interest rate (% p.a.)</label>
            <input id="interestRate" type="number" value="9.5" step="0.1" />
          </div>
          <div class="form-row">
            <label>Loan tenure (yrs)</label>
            <input id="loanTenure" type="number" value="10" />
          </div>
          <div class="form-row">
            <label>Processing fee (%)</label>
            <input id="processingFeePercent" type="number" value="0.5" step="0.1" />
          </div>
        </div>

        <div style="margin-top:10px" class="form-grid">
          <div class="form-row">
            <label>Annual property tax (‚Çπ)</label>
            <input id="propertyTax" type="number" value="5000" />
          </div>
          <div class="form-row">
            <label>Annual maintenance (‚Çπ)</label>
            <input id="maintenance" type="number" value="12000" />
          </div>
          <div class="form-row">
            <label>Inflation for costs (%) <span class="info" title="Used to escalate holding costs annually">i</span></label>
            <input id="inflationRate" type="number" value="6" step="0.1" />
          </div>
          <div class="form-row">
            <label>Opportunity cost (% p.a.)</label>
            <input id="opportunityCost" type="number" value="0" step="0.1" />
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div class="section-title">üìà Growth & Exit</div>
        <div class="form-grid">
          <div class="form-row">
            <label>Forecasted growth (% p.a.)</label>
            <input id="forecastedGrowth" type="number" value="10" step="0.1" />
          </div>
          <div class="form-row">
            <label>Growth model</label>
            <select id="growthModel"><option value="compound" selected>Compound</option><option value="linear">Linear</option></select>
          </div>
          <div class="form-row">
            <label>Market cycle</label>
            <select id="marketCycle"><option value="0.9">Soft</option><option value="1" selected>Neutral</option><option value="1.1">Rising</option></select>
          </div>
          <div class="form-row">
            <label>Infra / legal multiplier</label>
            <select id="combinedMultiplier"><option value="0.95">Below avg</option><option value="1" selected>Average</option><option value="1.05">Above avg</option><option value="1.1">Strong</option></select>
          </div>
          <div class="form-row">
            <label>Sales velocity</label>
            <select id="salesVelocity"><option value="0.98">Slow</option><option value="1" selected>Moderate</option><option value="1.02">Fast</option></select>
          </div>
          <div class="form-row">
            <label>Documentation grade</label>
            <select id="docGrade"><option value="0.98">Issues</option><option value="1" selected>Standard</option><option value="1.02">Premium</option></select>
          </div>
        </div>

        <div style="margin-top:12px" class="form-grid">
          <div class="form-row">
            <label>Holding period (yrs)</label>
            <input id="holdingPeriod" type="number" value="5" min="1" />
          </div>
          <div class="form-row">
            <label>Exit strategy</label>
            <select id="exitStrategy"><option value="normal">Normal</option><option value="quick">Quick (-10%)</option><option value="distress">Distress (-20%)</option><option value="premium">Premium (+5%)</option></select>
          </div>
          <div class="form-row">
            <label>Capital gains tax (est)</label>
            <select id="capitalGainsTax"><option value="20">Long term 20%</option><option value="30">Short term ~30%</option><option value="0">Reinvest (0%)</option></select>
          </div>
          <div class="form-row">
            <label>Selling costs (%)</label>
            <input id="sellingCosts" type="number" value="2" step="0.1" />
            <div class="helper">Brokerage, legal at exit</div>
          </div>
        </div>

        <div class="sensitivity">
          <label style="font-weight:700">Sensitivity analysis</label>
          <select id="sensitivityMode">
            <option value="off" selected>No</option>
            <option value="on">Yes (¬±3% growth)</option>
          </select>
          <div class="small" style="margin-left:auto">Quick insight helps investor risk check</div>
        </div>

        <div style="margin-top:12px">
          <button class="calc-btn" id="calcBtn">Calculate Analysis</button>
        </div>

      </div>

    </div>

    <!-- RIGHT: Results -->
    <aside class="results-col">
      <div class="panel" id="resultsSection" style="display:none" aria-live="polite">
        <div class="results-header">
          <div>
            <div class="section-title">üìä Investment Snapshot</div>
            <div class="small">One-page summary for investor / PDF export</div>
          </div>

          <div class="actions" aria-hidden="false" style="gap:6px">
            <button id="downloadPDF" class="icon-btn" title="Download PDF">
              <!-- download icon -->
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 20h14v-2H5v2zm7-18v10l4-4 1.4 1.4L12 16 6.6 9.4 8 8l4 4V2h0z"/></svg>Download
            </button>
            <button id="sharePDF" class="icon-btn" title="Share PDF">
              <!-- share icon -->
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a3.03 3.03 0 000-1.41l7.05-4.11A3.01 3.01 0 0018 7.92 3 3 0 1015 5a3 3 0 001.91 4.27L9.86 13.4a3 3 0 000 1.2l7.05 4.11A3 3 0 1018 16.08z"/></svg>Share
            </button>
          </div>
        </div>

        <div class="big-metric">
          <div class="label">Net Profit</div>
          <div class="value" id="netProfit">‚Çπ0</div>
          <div class="small" id="topInsight">Run calculation to show insight</div>
        </div>

        <div class="results-grid" style="margin-top:12px">
          <div class="stat">
            <div class="k" id="totalUpfrontCash">‚Çπ0</div>
            <div class="sub">Total Upfront Cash</div>
          </div>
          <div class="stat">
            <div class="k" id="totalInvestment">‚Çπ0</div>
            <div class="sub">Total Investment (holding)</div>
          </div>
          <div class="stat">
            <div class="k" id="expectedValue">‚Çπ0</div>
            <div class="sub">Expected Sale Value</div>
          </div>
          <div class="stat">
            <div class="k" id="roiPercent">0%</div>
            <div class="sub">ROI</div>
          </div>
          <div class="stat">
            <div class="k" id="cagr">0%</div>
            <div class="sub">CAGR</div>
          </div>
          <div class="stat">
            <div class="k" id="profitPerSqft">‚Çπ0</div>
            <div class="sub">Profit / sq ft</div>
          </div>
        </div>

        <div class="progress-wrap">
          <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px">
            <div>Performance Score</div><div id="performanceText" class="small">‚Äî</div>
          </div>
          <div class="progress"><div id="performanceScore" style="width:0%">0%</div></div>
        </div>

        <div class="timeline" id="yearlyBreakdownContainer" style="display:none">
          <div style="font-weight:700;color:var(--accent-dark);margin-bottom:6px">üìÖ Year-wise projection</div>
          <div id="yearlyBreakdown"></div>
        </div>

        <div class="comparison" id="comparisonTableContainer" style="display:none">
          <div style="font-weight:700;color:var(--accent-dark);margin-bottom:6px">Benchmark comparison</div>
          <table style="width:100%;font-size:13px;">
            <thead><tr style="text-align:left;color:var(--muted)"><th>Type</th><th style="text-align:right">CAGR</th><th style="text-align:right">Note</th></tr></thead>
            <tbody id="comparisonTable"></tbody>
          </table>
        </div>

        <div class="insights" style="margin-top:12px">
          <div class="insight" id="prosBox">
            <div style="font-weight:700;color:var(--accent-dark)">‚úÖ Strengths</div>
            <ul id="proslist" style="margin-top:8px"></ul>
          </div>
          <div class="insight" id="consBox">
            <div style="font-weight:700;color:#9b2a2a">‚ö†Ô∏è Risks</div>
            <ul id="conslist" style="margin-top:8px"></ul>
          </div>
        </div>

        <div class="assumptions">
          <div style="font-weight:700">Assumptions & notes</div>
          <div id="assumptionsText" style="margin-top:6px" class="small">
            Growth capped at ¬±25% p.a. | Loan EMI uses standard amortization | Indexation not applied in tax estimate | Figures are illustrative.
          </div>
        </div>

        <div class="disclaimer">
          This is an estimate and not investment advice. Check local laws and taxes before committing capital.
        </div>

      </div>
    </aside>
  </div>
</div>

<script>
/* ------------------ Utilities ------------------ */
const $ = id => document.getElementById(id);
const fmt = (n) => isFinite(n) ? n.toLocaleString('en-IN',{maximumFractionDigits:0}) : '0';
const fmt2 = (n, d=2) => isFinite(n) ? Number(n).toLocaleString('en-IN',{minimumFractionDigits:d,maximumFractionDigits:d}) : '0.00';
const STAMP = {up:.07,mh:.055,dl:.06,ka:.05,tn:.07,rj:.055,gj:.049,hr:.065,mp:.075,pb:.07};

function unitToSqft(value, unit){
  if(!value) return 0;
  if(unit==='sqyard') return value*9;
  if(unit==='sqmeter') return value*10.76391041671;
  return value;
}

/* ------------------ Live previews ------------------ */
function liveUpdates(){
  const purchasePrice = Number($.purchasePrice.value)||0;
  const plotSize = Number($.plotSize.value)||1;
  const pricePerUnit = purchasePrice/Math.max(1,plotSize);
  $('pricePerUnit').textContent = '‚Çπ' + fmt2(pricePerUnit,2);
  const circleRate = Number($.circleRate.value)||0;
  const cmpPct = circleRate ? ((pricePerUnit/circleRate)-1)*100 : 0;
  $('circleRateComparison').textContent = circleRate ? (cmpPct>0 ? `Above circle by ${cmpPct.toFixed(1)}%` : `Below circle by ${Math.abs(cmpPct).toFixed(1)}%`) : '';
}
['purchasePrice','plotSize','circleRate','plotUnit','state','registrationCost','gstApplicable','brokerage','lawyerFees','miscCosts',
 'loanTaken','loanAmount','interestRate','loanTenure','processingFeePercent','propertyTax','maintenance','inflationRate',
 'forecastedGrowth','growthModel','marketCycle','combinedMultiplier','salesVelocity','docGrade','macro',
 'holdingPeriod','exitStrategy','capitalGainsTax','sellingCosts','planConstruct','constructionCostPerSqft','builtupArea','monthlyRent','vacancyRate','rentalMaintenance','rentGrowth'
].forEach(id=>{
  const el = document.getElementById(id);
  if(el){ el.addEventListener('input', liveUpdates); el.addEventListener('change', liveUpdates); }
});

/* ------------------ Core calculation & UI bind ------------------ */
function calculate(){
  try{
    // read inputs
    const purchasePrice = Number($.purchasePrice.value)||0;
    const plotSize = Number($.plotSize.value)||1;
    const plotUnit = $.plotUnit.value;
    const plotSizeSqft = unitToSqft(plotSize, plotUnit) || 1;

    const registrationCost = Number($.registrationCost.value)||0;
    const lawyerFees = Number($.lawyerFees.value)||0;
    const miscCosts = Number($.miscCosts.value)||0;
    const brokeragePct = Number($.brokerage.value)||0;
    const state = $.state.value;
    const stampDuty = purchasePrice * (STAMP[state]||0);
    const gst = ($.gstApplicable.value==='yes') ? purchasePrice*0.12 : 0;
    const brokerageCost = purchasePrice*(brokeragePct/100);

    const planConstruct = ($.planConstruct && $.planConstruct.value==='yes');
    const totalConstructionCost = planConstruct ? (Number($.constructionCostPerSqft.value)||0)*(Number($.builtupArea.value)||0) : 0;

    const loanTaken = $.loanTaken.value==='yes';
    const loanAmount = loanTaken ? (Number($.loanAmount.value)||0) : 0;
    const interestRate = loanTaken ? (Number($.interestRate.value)||0) : 0;
    const loanTenure = loanTaken ? (Number($.loanTenure.value)||0) : 0;
    const processingFee = loanTaken ? loanAmount*(Number($.processingFeePercent.value||0)/100) : 0;

    const propertyTax = Number($.propertyTax.value)||0;
    const maintenance = Number($.maintenance.value)||0;
    const inflationRate = Number($.inflationRate.value)||0;
    const holdingPeriod = Math.max(1, Number($.holdingPeriod.value)||1);
    const exitStrategy = $.exitStrategy.value;
    const capitalGainsTaxRate = Number($.capitalGainsTax.value)||0;
    const sellingCostsPct = Number($.sellingCosts.value)||0;

    // growth adj
    const baseGrowth = (Number($.forecastedGrowth.value)||0)/100;
    const marketCycle = Number($.marketCycle.value)||1;
    const combinedMultiplierBase = Number($.combinedMultiplier.value)||1;
    const riskNudges = (Number($.salesVelocity.value)||1) * (Number($.docGrade.value)||1) * (Number($.macro ? $.macro.value : 1)||1);
    const combinedMultiplier = Math.min(1.3, Math.max(0.8, combinedMultiplierBase * riskNudges));
    let adjGrowth = baseGrowth * combinedMultiplier * marketCycle;
    adjGrowth = Math.min(0.25, Math.max(-0.20, adjGrowth));

    const growthModel = $.growthModel.value;

    // expected value path
    let expectedValue = purchasePrice;
    const yearlyValues = [];
    if(growthModel==='linear'){
      expectedValue = purchasePrice * (1 + adjGrowth * holdingPeriod);
      for(let i=1;i<=holdingPeriod;i++){
        yearlyValues.push({year:i, value: purchasePrice*(1 + adjGrowth * i)});
      }
    } else {
      expectedValue = purchasePrice * Math.pow(1+adjGrowth, holdingPeriod);
      for(let i=1;i<=holdingPeriod;i++){
        yearlyValues.push({year:i, value: purchasePrice * Math.pow(1+adjGrowth, i)});
      }
    }

    if(exitStrategy==='quick') expectedValue *= 0.90;
    else if(exitStrategy==='distress') expectedValue *= 0.80;
    else if(exitStrategy==='premium') expectedValue *= 1.05;

    const sellingExpense = expectedValue * (sellingCostsPct/100);

    // tax base for capital gains
    const acquisitionForTax = purchasePrice + stampDuty + registrationCost + brokerageCost + lawyerFees + miscCosts + gst + totalConstructionCost;
    const capitalGainForTax = expectedValue - sellingExpense - acquisitionForTax;
    const taxAmount = capitalGainForTax>0 ? capitalGainForTax * (capitalGainsTaxRate/100) : 0;

    // loan amortization (if any)
    let totalInterestPaid = 0, loanBalance = 0, emi = 0;
    if(loanTaken){
      const r = (interestRate/100)/12;
      const n = Math.max(1, loanTenure*12);
      emi = r>0 ? loanAmount * r * Math.pow(1+r,n) / (Math.pow(1+r,n)-1) : loanAmount/n;
      const m = Math.min(holdingPeriod*12, n);
      loanBalance = loanAmount;
      for(let i=0;i<m;i++){
        const interest = loanBalance*r;
        const principal = emi - interest;
        totalInterestPaid += interest;
        loanBalance -= principal;
      }
      loanBalance = Math.max(0, loanBalance);
    }

    // upfront & holding costs
    const downPayment = loanTaken ? Math.max(0, purchasePrice - loanAmount) : purchasePrice;
    const upfrontPurchaseCosts = stampDuty + registrationCost + gst + brokerageCost + lawyerFees + miscCosts;
    const upfrontConstruction = planConstruct ? totalConstructionCost : 0;
    const totalUpfrontCash = downPayment + upfrontPurchaseCosts + (loanTaken ? processingFee : 0) + upfrontConstruction;

    let totalHoldingCost = 0;
    for(let y=1;y<=holdingPeriod;y++){
      totalHoldingCost += (propertyTax + maintenance) * Math.pow(1 + (inflationRate/100), y-1);
    }

    // rental optional
    let totalRentNet = 0;
    if(planConstruct){
      const monthlyRent = Number($.monthlyRent.value)||0;
      const vacancy = Number($.vacancyRate.value)||0;
      const rentGrowth = (Number($.rentGrowth.value)||0)/100;
      const annualMaintRent = Number($.rentalMaintenance.value)||0;
      let yearRent = monthlyRent*12*(1 - vacancy/100) - annualMaintRent;
      for(let y=1;y<=holdingPeriod;y++){
        totalRentNet += yearRent;
        yearRent *= (1 + rentGrowth);
      }
    }

    const totalInvestment = totalUpfrontCash + totalHoldingCost + totalInterestPaid - totalRentNet;
    const netSaleProceeds = expectedValue - sellingExpense - taxAmount - (loanTaken ? loanBalance : 0);
    const netProfit = netSaleProceeds - totalInvestment;
    const roiPercent = totalInvestment>0 ? (netProfit/totalInvestment)*100 : 0;
    const cagr = (totalInvestment>0 && holdingPeriod>0) ? (Math.pow(netSaleProceeds/totalInvestment, 1/holdingPeriod) - 1)*100 : 0;
    const profitPerSqft = plotSizeSqft>0 ? netProfit/plotSizeSqft : 0;

    // Bind UI
    $('totalUpfrontCash').textContent = '‚Çπ' + fmt(totalUpfrontCash);
    $('totalInvestment').textContent = '‚Çπ' + fmt(totalInvestment);
    $('expectedValue').textContent = '‚Çπ' + fmt(expectedValue);
    $('capitalGainForTax')?.textContent && ($('capitalGainForTax').textContent = '‚Çπ' + fmt(capitalGainForTax));
    $('taxAmount')?.textContent && ($('taxAmount').textContent = '‚Çπ' + fmt(taxAmount));
    $('netSaleProceeds')?.textContent && ($('netSaleProceeds').textContent = '‚Çπ' + fmt(netSaleProceeds));
    $('netProfit').textContent = '‚Çπ' + fmt(netProfit);
    $('roiPercent').textContent = (isFinite(roiPercent)?roiPercent:0).toFixed(2) + '%';
    $('cagr').textContent = (isFinite(cagr)?cagr:0).toFixed(2) + '%';
    $('profitPerSqft').textContent = '‚Çπ' + fmt2(profitPerSqft,2);

    // Performance score & text
    const perf = Math.min(100, Math.max(0, 50 + ((cagr-10)*3)));
    $('performanceScore').style.width = perf.toFixed(0) + '%';
    $('performanceScore').textContent = perf.toFixed(0) + '%';
    $('performanceText').textContent = perf>=85 ? 'Outstanding' : perf>=70 ? 'Excellent' : perf>=55 ? 'Good' : perf>=40 ? 'Average' : 'Below expectations';

    // Yearly breakdown
    let yHTML = '';
    yearlyValues.forEach(v=>{
      const growthPct = ((v.value/purchasePrice)-1)*100;
      yHTML += `<div class="timeline-item"><div>Year ${v.year}</div><div style="font-weight:700;color:var(--accent-dark)">‚Çπ${fmt(v.value)}</div><div style="color:var(--muted)}">${growthPct>=0?'+':''}${growthPct.toFixed(1)}%</div></div>`;
    });
    $('yearlyBreakdown').innerHTML = yHTML;
    $('yearlyBreakdownContainer').style.display = 'block';

    // Comparison (illustrative)
    const cagrVal = isFinite(cagr) ? cagr : 0;
    const comps = [
      {type:'Your Plot Investment', cagr:cagrVal, key:true},
      {type:'Gold (long-term)', cagr:9},
      {type:'Fixed Deposit', cagr:6.5},
      {type:'Nifty 50 (LT avg)', cagr:12},
      {type:'Real Estate (India avg)', cagr:8.5}
    ];
    $('comparisonTable').innerHTML = comps.map(row=>{
      const comp = row.key ? '‚Äî' : (cagrVal>row.cagr ? `Better by ${(cagrVal-row.cagr).toFixed(1)}%` : `Lower by ${(row.cagr-cagrVal).toFixed(1)}%`);
      return `<tr><td style="padding:6px 0">${row.type}</td><td style="text-align:right;padding:6px 0;">${row.cagr.toFixed(2)}%</td><td style="text-align:right;padding:6px 0;">${comp}</td></tr>`;
    }).join('');
    $('comparisonTableContainer').style.display = 'block';

    // Pros / cons
    const pros = [], cons = [];
    if(cagrVal>12) pros.push('CAGR strong vs common benchmarks');
    if(roiPercent>60) pros.push('Healthy cash ROI');
    if(totalRentNet>0) pros.push('Rental inflow offsets costs');
    if(planConstruct && totalConstructionCost>0) pros.push('Improvements raise basis & income');

    if(cagrVal<8) cons.push('Projected CAGR near/below RE averages');
    if(totalInterestPaid>0 && roiPercent<12) cons.push('Loan interest pressure on returns');
    if(sellingExpense/Math.max(1,expectedValue) > 0.03) cons.push('High exit costs reduce net proceeds');
    if(capitalGainForTax<=0) cons.push('Low/negative capital gain after eligible costs');

    $('proslist').innerHTML = pros.length ? pros.map(p=>`<li>${p}</li>`).join('') : '<li>Real estate can hedge inflation</li>';
    $('conslist').innerHTML = cons.length ? cons.map(c=>`<li>${c}</li>`).join('') : '<li>Illiquidity risk</li>';

    // top insight
    $('topInsight').textContent = netProfit>0 ? `Projected profit ‚Çπ${fmt(netProfit)} ‚Ä¢ CAGR ${fmt2(cagr,2)}%` : 'Projected outcome may be negative ‚Äî check assumptions';

    // show results
    $('resultsSection').style.display = 'block';
    $('resultsSection').scrollIntoView({behavior:'smooth', block:'start'});

    // Sensitivity (if enabled)
    const sens = ($.sensitivityMode.value === 'on');
    if(sens){
      const delta = 0.03;
      const lowGrowth = Math.max(-0.2, adjGrowth - delta);
      const highGrowth = Math.min(0.25, adjGrowth + delta);
      const scenarios = [
        {label:'Worst (growth -3%)', g:lowGrowth},
        {label:'Base', g:adjGrowth},
        {label:'Best (growth +3%)', g:highGrowth}
      ];
      // compute CAGR & profit for each scenario quickly (simple comp)
      let sensHTML = '<div style="font-weight:700;color:var(--accent-dark);margin-bottom:6px">Sensitivity (¬±3%)</div>';
      scenarios.forEach(s=>{
        let ev = purchasePrice * Math.pow(1+s.g, holdingPeriod);
        if(exitStrategy==='quick') ev *= 0.9;
        else if(exitStrategy==='distress') ev *= 0.8;
        else if(exitStrategy==='premium') ev *= 1.05;
        const sellExp = ev * (sellingCostsPct/100);
        const cg = ev - sellExp - acquisitionForTax;
        const tax = cg>0 ? cg*(capitalGainsTaxRate/100) : 0;
        const netProceeds = ev - sellExp - tax - (loanTaken ? loanBalance : 0);
        const netProf = netProceeds - totalInvestment;
        const cagrSc = (totalInvestment>0 && holdingPeriod>0) ? (Math.pow(netProceeds/totalInvestment, 1/holdingPeriod) - 1)*100 : 0;
        sensHTML += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-top:1px dashed #f1f6ff"><div>${s.label}</div><div style="text-align:right"><div style="font-weight:800">‚Çπ${fmt(netProf)}</div><div style="font-size:12px;color:var(--muted)">${cagrSc.toFixed(1)}% CAGR</div></div></div>`;
      });
      // append sensitivity summary to assumptions area
      $('assumptionsText').innerHTML = `Growth cap ¬±25% ‚Ä¢ Loan EMI amortised ‚Ä¢ Indexation not applied.<div style="margin-top:8px">${sensHTML}</div>`;
    } else {
      $('assumptionsText').innerHTML = `Growth capped at ¬±25% p.a. | Loan EMI uses standard amortization | Indexation not applied in tax estimate | Figures illustrative.`;
    }

    // Save some values to global for PDF generation
    window._AARIA_REPORT = {
      purchasePrice, plotSize, plotUnit, stampDuty, gst, brokerageCost, totalUpfrontCash, totalInvestment, expectedValue,
      capitalGainForTax, taxAmount, netSaleProceeds, netProfit, roiPercent, cagr, profitPerSqft, yearlyValues
    };

  } catch(e){
    console.error('Calculate error', e);
    alert('Calculation error ‚Äî check console.');
  }
}

/* ---------- PDF generation & share ---------- */
async function generatePDF_save(){
  const container = document.createElement('div');
  // build a printable snapshot: header + inputs summary + results (clone resultsSection)
  const title = document.createElement('div');
  title.style.fontFamily = 'Inter, system-ui';
  title.style.padding = '14px';
  title.style.borderBottom = '1px solid #eee';
  title.innerHTML = `<h2 style="margin:0;color:#13344b">AARIA ‚Äî Investment Analysis</h2><div style="color:#6b7f8f;font-size:12px;margin-top:6px">Generated: ${new Date().toLocaleString()}</div>`;

  // inputs summary
  const inputs = window._AARIA_REPORT || {};
  const inputsHtml = `
    <div style="padding:12px;font-size:13px">
      <strong>Inputs snapshot</strong>
      <table style="width:100%;margin-top:8px;font-size:12px;border-collapse:collapse">
        <tr><td style="padding:6px;border-top:1px solid #f2f4f7">Purchase Price</td><td style="padding:6px;border-top:1px solid #f2f4f7">‚Çπ${fmt(inputs.purchasePrice||0)}</td></tr>
        <tr><td style="padding:6px;border-top:1px solid #f2f4f7">Plot Size</td><td style="padding:6px;border-top:1px solid #f2f4f7">${inputs.plotSize||0} ${inputs.plotUnit||'sqft'}</td></tr>
        <tr><td style="padding:6px;border-top:1px solid #f2f4f7">Total Upfront Cash</td><td style="padding:6px;border-top:1px solid #f2f4f7">‚Çπ${fmt(inputs.totalUpfrontCash||0)}</td></tr>
      </table>
    </div>
  `;

  // results clone
  const resultsClone = $('resultsSection').cloneNode(true);
  // tidy clone: remove action buttons inside
  const btns = resultsClone.querySelectorAll('#downloadPDF, #sharePDF');
  btns.forEach(b=>b.remove());

  // append generically
  container.appendChild(title);
  const wrap = document.createElement('div');
  wrap.appendChild((new DOMParser()).parseFromString(inputsHtml,'text/html').body.firstChild);
  wrap.appendChild(resultsClone);
  document.body.appendChild(container); // temporarily needed for html2pdf to read styles
  // create options
  const opt = {
    margin: [10,10,10,10],
    filename: `Aaria_Report_${Date.now()}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale:2, useCORS:true, allowTaint:true },
    jsPDF: { unit:'mm', format:'a4', orientation:'portrait' }
  };
  // perform pdf generation
  await html2pdf().from(wrap).set(opt).save();
  // cleanup
  document.body.removeChild(container);
}

async function generatePDF_blob(){
  // build same container
  const container = document.createElement('div');
  const title = document.createElement('div');
  title.style.fontFamily = 'Inter, system-ui';
  title.style.padding = '14px';
  title.style.borderBottom = '1px solid #eee';
  title.innerHTML = `<h2 style="margin:0;color:#13344b">AARIA ‚Äî Investment Analysis</h2><div style="color:#6b7f8f;font-size:12px;margin-top:6px">Generated: ${new Date().toLocaleString()}</div>`;
  container.appendChild(title);
  const resultsClone = $('resultsSection').cloneNode(true);
  const btns = resultsClone.querySelectorAll('#downloadPDF, #sharePDF');
  btns.forEach(b=>b.remove());
  container.appendChild(resultsClone);
  document.body.appendChild(container);

  const opt = {
    margin: [10,10,10,10],
    filename: `Aaria_Report_${Date.now()}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale:2, useCORS:true, allowTaint:true },
    jsPDF: { unit:'mm', format:'a4', orientation:'portrait' }
  };

  const pdfBlob = await html2pdf().from(container).set(opt).outputPdf('blob');
  document.body.removeChild(container);
  return pdfBlob;
}

/* ---------- Event wiring ---------- */
$('calcBtn').addEventListener('click', () => { calculate(); });

// Attach download
$('downloadPDF').addEventListener('click', async (e)=>{
  // quick guard
  if(!window._AARIA_REPORT){ alert('Please run calculation first'); return; }
  e.currentTarget.disabled = true;
  e.currentTarget.textContent = 'Generating...';
  try{ await generatePDF_save(); } catch(err){ console.error(err); alert('PDF generation failed'); }
  e.currentTarget.disabled = false;
  e.currentTarget.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 20h14v-2H5v2zm7-18v10l4-4 1.4 1.4L12 16 6.6 9.4 8 8l4 4V2h0z"/></svg>Download`;
});

// Attach share
$('sharePDF').addEventListener('click', async (e)=>{
  if(!window._AARIA_REPORT){ alert('Please run calculation first'); return; }
  e.currentTarget.disabled = true;
  e.currentTarget.textContent = 'Preparing...';
  try{
    const blob = await generatePDF_blob();
    const file = new File([blob], `Aaria_Report_${Date.now()}.pdf`, { type: 'application/pdf' });
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({ title:'AARIA Investment Report', text:'Investment analysis from AARIA', files:[file] });
    } else if(navigator.share){
      // some browsers allow share without files
      await navigator.share({ title:'AARIA Investment Report', text:'I generated an investment report. Download from attachment.' });
      alert('Sharing limited on this device ‚Äî PDF generated in the background.');
    } else {
      alert('Web Share not supported on this device ‚Äî PDF will be downloaded instead.');
      // fallback to download
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = file.name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
  }catch(err){
    console.error('Share error', err);
    alert('Unable to share: ' + (err && err.message || ''));
  }finally{
    e.currentTarget.disabled = false;
    e.currentTarget.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a3.03 3.03 0 000-1.41l7.05-4.11A3.01 3.01 0 0018 7.92 3 3 0 1015 5a3 3 0 001.91 4.27L9.86 13.4a3 3 0 000 1.2l7.05 4.11A3 3 0 1018 16.08z"/></svg>Share`;
  }
});

/* init */
liveUpdates();
</script>
</body>
</html>
