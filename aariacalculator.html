<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AARIA ‚Ä¢ Plot Investment ROI + IRR + Indexation (CII)</title>
<!-- Minimal reset + theme -->
<style>
  :root{
    --pri:#2a5298;--pri2:#667eea;--ok:#27ae60;--bad:#e74c3c;--mut:#6b7280;--bg:#f6f7fb
  }
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2) fixed;min-height:100vh;padding:18px}
  .container{max-width:1200px;margin:auto;background:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
  .header{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;padding:28px;text-align:center}
  .header h1{margin:0 0 6px;font-size:2rem}
  .sub{opacity:.9}
  .wrap{padding:24px}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .card{background:#f8f9fb;border:1px solid #e5e7eb;border-radius:14px;padding:16px}
  h2.section{font-size:1.1rem;color:var(--pri);margin:0 0 10px;border-bottom:3px solid var(--pri2);padding-bottom:8px}
  label{font-weight:600;font-size:.9rem;color:#111}
  input,select{width:100%;padding:10px 12px;border:2px solid #e5e7eb;border-radius:10px;font-size:0.95rem;outline:0;transition:.2s}
  input:focus,select:focus{border-color:var(--pri2);box-shadow:0 0 0 3px rgba(102,126,234,.15)}
  .hint{font-size:.75rem;color:#555;margin-top:6px}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#eef2ff;color:#1d4ed8;border-radius:999px;padding:6px 10px;font-size:.8rem}
  .btn{cursor:pointer;border:0;border-radius:12px;padding:14px 22px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:700}
  .btn:active{transform:translateY(1px)}
  .results{background:linear-gradient(135deg,#f5f7fa,#c3cfe2);border-radius:14px;padding:18px;margin-top:16px}
  .kpis{display:grid;gap:14px}
  @media(min-width:900px){.kpis{grid-template-columns:repeat(4,minmax(0,1fr))}}
  .kpi{background:#fff;border-radius:12px;padding:14px;border:1px solid #e5e7eb;text-align:center}
  .kpi h4{margin:0 0 6px;color:#6b7280;font-size:.8rem;letter-spacing:.04em;text-transform:uppercase}
  .kpi .v{font-size:1.5rem;font-weight:800;color:var(--pri)}
  .kpi.pos .v{color:var(--ok)} .kpi.neg .v{color:var(--bad)}
  .progress{height:36px;background:#e5e7eb;border-radius:18px;overflow:hidden}
  .fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;transition:width .8s}
  .timeline{background:#fff;border-radius:12px;border:1px solid #e5e7eb;padding:16px}
  .row{display:flex;gap:10px;padding:10px 8px;border-bottom:1px dashed #e5e7eb;font-size:.9rem}
  .row:last-child{border-bottom:0}
  .row > div{flex:1}
  .badge{padding:3px 8px;border-radius:999px;font-size:.75rem}
  .b-ok{background:#e8f8ee;color:#14532d}.b-bad{background:#fde8e8;color:#7f1d1d}.b-warn{background:#fff7ed;color:#7c2d12}
  .insights{display:grid;gap:14px}
  @media(min-width:900px){.insights{grid-template-columns:1fr 1fr}}
  .ins{border-left:6px solid #10b981;background:#ecfeff;border-radius:12px;padding:14px}
  .ins h3{margin:0 0 8px;color:#064e3b}
  .risk{border-left:6px solid #ef4444;background:#fff1f2}
  .risk h3{color:#7f1d1d}
  .tiny-actions{display:flex;gap:12px;justify-content:flex-end;align-items:center;margin-top:10px}
  .icon-btn{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:8px;cursor:pointer;display:inline-flex}
  .icon-btn svg{width:18px;height:18px}
  .footnote{font-size:.8rem;color:var(--mut);margin-top:8px}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
  .modal .box{background:#fff;max-width:900px;width:100%;border-radius:14px;max-height:80vh;overflow:auto;padding:18px}
  .box h3{margin:0 0 10px;color:var(--pri)}
  .def{padding:10px 0;border-bottom:1px dashed #e5e7eb}
  .tag{font-weight:700}
</style>
<!-- html2canvas + jsPDF (for client-side PDF) -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>‚úÖ AARIA ‚Ä¢ Plot Investment ROI & IRR Calculator</h1>
      <div class="sub">Market-standard math ‚Ä¢ CII Indexation ‚Ä¢ Monthly IRR ‚Ä¢ Aaria‚Äôs Smart Suggestions (Style B)</div>
    </div>

    <div class="wrap">
      <!-- BASIC -->
      <div class="card">
        <h2 class="section">üèóÔ∏è Plot & Purchase (Market-standard)</h2>
        <div class="grid cols-3">
          <div>
            <label>Purchase Price (‚Çπ)</label>
            <input id="purchasePrice" type="number" value="1500000" />
            <div class="hint">Agreement value of land (land generally has no GST).</div>
          </div>
          <div>
            <label>Plot Size</label>
            <input id="plotSize" type="number" value="1000" />
            <div class="hint">Enter numeric size.</div>
          </div>
          <div>
            <label>Unit</label>
            <select id="plotUnit">
              <option value="sqft" selected>Square Feet</option>
              <option value="sqyard">Square Yards</option>
              <option value="sqmeter">Square Meters</option>
            </select>
          </div>

          <div>
            <label>State (Stamp Duty %)</label>
            <select id="state">
              <option value="UP|7">Uttar Pradesh (‚âà7%)</option>
              <option value="MH|6">Maharashtra (‚âà6%)</option>
              <option value="DL|6">Delhi (‚âà6%)</option>
              <option value="KA|5">Karnataka (‚âà5%)</option>
              <option value="TN|7">Tamil Nadu (‚âà7%)</option>
              <option value="RJ|6">Rajasthan (‚âà6%)</option>
              <option value="GJ|4.9">Gujarat (‚âà4.9%)</option>
              <option value="HR|7">Haryana (‚âà7%)</option>
              <option value="MP|7.5">Madhya Pradesh (‚âà7.5%)</option>
              <option value="PB|7">Punjab (‚âà7%)</option>
            </select>
            <div class="hint">You can override % below if needed.</div>
          </div>
          <div>
            <label>Stamp Duty (%)</label>
            <input id="stampPct" type="number" step="0.1" value="7" />
          </div>
          <div>
            <label>Registration Cost (‚Çπ)</label>
            <input id="registrationCost" type="number" value="10000" />
          </div>

          <div>
            <label>Brokerage to Buy (%)</label>
            <input id="brokerageBuyPct" type="number" value="1.0" step="0.1" />
          </div>
          <div>
            <label>Legal/Consultancy at Purchase (‚Çπ)</label>
            <input id="legalPurchase" type="number" value="15000" />
          </div>
          <div>
            <label>Misc Purchase Costs (‚Çπ)</label>
            <input id="miscPurchase" type="number" value="5000" />
          </div>

          <div class="inline">
            <input id="gstApplicable" type="checkbox" />
            <label for="gstApplicable">GST applicable? (generally No for land)</label>
          </div>
          <div>
            <label>GST on Purchase (%)</label>
            <input id="gstPct" type="number" value="12" step="0.1" />
            <div class="hint">Used only if GST box checked.</div>
          </div>
          <div class="inline">
            <span class="pill" id="ppu">Price/Unit: ‚Äî</span>
            <button class="btn" id="defsBtn" type="button">üìò Term Definitions</button>
          </div>
        </div>
      </div>

      <!-- LOAN -->
      <div class="card">
        <h2 class="section">üè¶ Loan (optional)</h2>
        <div class="grid cols-3">
          <div>
            <label>Using Loan?</label>
            <select id="useLoan">
              <option value="no" selected>No (Cash)</option>
              <option value="yes">Yes (Home/Loan)</option>
            </select>
          </div>
          <div>
            <label>Loan Amount (‚Çπ)</label>
            <input id="loanAmount" type="number" value="900000" />
            <div class="hint">Typically ‚â§80% of value.</div>
          </div>
          <div>
            <label>Interest Rate (% p.a.)</label>
            <input id="interestRate" type="number" value="9.0" step="0.1" />
          </div>
          <div>
            <label>Loan Tenure (years)</label>
            <input id="loanTenure" type="number" value="10" />
          </div>
          <div>
            <label>Processing Fee (% of loan)</label>
            <input id="processingPct" type="number" value="0.5" step="0.1" />
          </div>
          <div class="inline">
            <span class="pill" id="emiShow">EMI: ‚Äî</span>
            <span class="pill" id="intShow">Total Interest (till sale): ‚Äî</span>
          </div>
        </div>
      </div>

      <!-- HOLDING -->
      <div class="card">
        <h2 class="section">üìÖ Holding & Ongoing</h2>
        <div class="grid cols-3">
          <div>
            <label>Holding Period (years)</label>
            <input id="holdingYears" type="number" value="5" />
          </div>
          <div>
            <label>Property Tax / year (‚Çπ)</label>
            <input id="propTax" type="number" value="3000" />
          </div>
          <div>
            <label>Maintenance / year (‚Çπ)</label>
            <input id="maint" type="number" value="6000" />
          </div>
          <div>
            <label>Cost Escalation (Inflation) %</label>
            <input id="inflationPct" type="number" value="5" step="0.1" />
          </div>
          <div>
            <label>Expected Market Growth (% p.a.)</label>
            <input id="growthPct" type="number" value="10" step="0.1" />
          </div>
          <div>
            <label>Exit Selling Costs (% of sale)</label>
            <input id="sellCostPct" type="number" value="2" step="0.1" />
          </div>
        </div>
      </div>

      <!-- INDEXATION (CII) -->
      <div class="card">
        <h2 class="section">üßÆ Capital Gains & Indexation (CII) ‚Äî Mode B (Manual FY CII)</h2>
        <div class="grid cols-3">
          <div>
            <label>Financial Year of Purchase (CII)</label>
            <input id="ciiPurchase" type="number" placeholder="e.g. 348" />
            <div class="hint">Enter official CII for purchase FY.</div>
          </div>
          <div>
            <label>Financial Year of Sale (CII)</label>
            <input id="ciiSale" type="number" placeholder="e.g. 360" />
            <div class="hint">Enter official CII for sale FY.</div>
          </div>
          <div>
            <label>Buyer‚Äôs Income Tax Slab (%) for STCG</label>
            <input id="stcgSlab" type="number" value="30" step="1" />
          </div>
          <div class="inline">
            <input id="includeCostsInCOA" type="checkbox" checked />
            <label for="includeCostsInCOA">Include stamp duty, registration & purchase-brokerage in Cost of Acquisition (COA)</label>
          </div>
        </div>
        <div class="hint">LTCG applies if holding &gt; 24 months. LTCG tax assumed @20% with indexation. STCG taxed at slab.</div>
      </div>

      <!-- OPTIONAL RENT (kept simple) -->
      <div class="card">
        <h2 class="section">üè† Optional Rent (if any while holding)</h2>
        <div class="grid cols-3">
          <div>
            <label>Monthly Rent (‚Çπ)</label>
            <input id="rentMonthly" type="number" value="0" />
          </div>
          <div>
            <label>Vacancy (% of year)</label>
            <input id="vacancyPct" type="number" value="10" step="1" />
          </div>
          <div>
            <label>Annual Rent Growth (%)</label>
            <input id="rentGrowthPct" type="number" value="4" step="0.5" />
          </div>
        </div>
      </div>

      <!-- ACTION -->
      <div class="inline" style="justify-content:space-between;margin:10px 0 6px">
        <div class="inline">
          <span class="pill">Market standard math</span>
          <span class="pill">CII Indexation (Manual)</span>
          <span class="pill">Monthly IRR</span>
        </div>
        <button class="btn" id="calcBtn">üöÄ Calculate</button>
      </div>

      <!-- RESULTS -->
      <div id="results" class="results" style="display:none">
        <h2 class="section" style="border:0;padding:0;margin:0 0 12px;color:#1e3c72;font-size:1.3rem">üìä Investment Summary</h2>
        <div class="kpis">
          <div class="kpi"><h4>Total Upfront Cost</h4><div class="v" id="k_upfront">‚Äî</div><div class="footnote">Cash paid at purchase (incl. duties, fees)</div></div>
          <div class="kpi"><h4>Total Cash Invested</h4><div class="v" id="k_totalinv">‚Äî</div><div class="footnote">All negative cash flows till sale</div></div>
          <div class="kpi"><h4>Expected Sale Value</h4><div class="v" id="k_sale">‚Äî</div><div class="footnote">Market growth compounded</div></div>
          <div class="kpi"><h4>Loan Payoff @ Exit</h4><div class="v" id="k_payoff">‚Äî</div><div class="footnote">Remaining principal at sale</div></div>

          <div class="kpi"><h4>Gross Profit (pre-tax)</h4><div class="v" id="k_gross">‚Äî</div></div>
          <div class="kpi"><h4>Capital Gains Tax</h4><div class="v" id="k_tax">‚Äî</div><div class="footnote" id="k_taxmode">‚Äî</div></div>
          <div class="kpi"><h4>Net Profit</h4><div class="v" id="k_net">‚Äî</div></div>
          <div class="kpi"><h4>ROI</h4><div class="v" id="k_roi">‚Äî</div><div class="footnote">Net / Total Cash Invested</div></div>

          <div class="kpi"><h4>CAGR (simple)</h4><div class="v" id="k_cagr">‚Äî</div></div>
          <div class="kpi"><h4>IRR (monthly)</h4><div class="v" id="k_irr">‚Äî</div><div class="footnote">Based on full cashflow timeline</div></div>
          <div class="kpi"><h4>Profit per Sq Ft</h4><div class="v" id="k_pps">‚Äî</div></div>
          <div class="kpi"><h4>Performance Score</h4><div class="v" id="k_score">‚Äî</div></div>
        </div>

        <div style="margin:14px 0">
          <div class="progress"><div id="scoreBar" class="fill" style="width:0%">0%</div></div>
        </div>

        <!-- IRR timeline table -->
        <div class="timeline" id="timeline">
          <div class="inline" style="justify-content:space-between;align-items:center">
            <h3 style="margin:0;color:var(--pri)">üìÖ Monthly Cash Flow Timeline (IRR)</h3>
            <span class="badge b-warn" id="monthsInfo">‚Äî months</span>
          </div>
          <div class="row" style="font-weight:700;background:#f8fafc">
            <div>Month</div><div>Cash Flow (‚Çπ)</div><div>Reason</div><div>Running Balance (‚Çπ)</div>
          </div>
          <div id="flowRows"></div>
        </div>

        <!-- Insights (Style B) -->
        <div class="insights" style="margin-top:14px">
          <div class="ins">
            <h3>‚úÖ Aaria‚Äôs Suggestions</h3>
            <ul id="prosList" style="margin:0 0 0 18px;line-height:1.8"></ul>
          </div>
          <div class="ins risk">
            <h3>‚ö†Ô∏è Key Risks / Watch-outs</h3>
            <ul id="consList" style="margin:0 0 0 18px;line-height:1.8"></ul>
          </div>
        </div>

        <!-- Share / PDF -->
        <div class="tiny-actions">
          <button class="icon-btn" id="shareBtn" title="Share summary">
            <!-- share icon -->
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7"/>
              <polyline points="16 6 12 2 8 6"/>
              <line x1="12" y1="2" x2="12" y2="15"/>
            </svg>
          </button>
          <button class="icon-btn" id="pdfBtn" title="Download PDF report">
            <!-- download icon -->
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
          </button>
        </div>
        <div class="footnote">PDF method: client-side generation with html2canvas + jsPDF. Your clients can view & you (or they) can download.</div>
      </div>
    </div>
  </div>

  <!-- DEFINITIONS MODAL -->
  <div id="defs" class="modal" role="dialog" aria-modal="true" aria-label="Term Definitions">
    <div class="box">
      <div class="inline" style="justify-content:space-between;align-items:center">
        <h3>üìò Definitions (market-standard)</h3>
        <button class="icon-btn" id="defsClose" title="Close">‚úñÔ∏è</button>
      </div>
      <div class="def"><span class="tag">Total Upfront Cost:</span> Purchase price + stamp duty + registration + purchase-brokerage + legal + misc + (GST if chosen) + loan processing fee (if any).</div>
      <div class="def"><span class="tag">Total Cash Invested:</span> Sum of all negative cash flows from start until sale (upfront outflows, EMIs paid till sale, property tax, maintenance, other costs), net of any positive inflows before sale (e.g., rent).</div>
      <div class="def"><span class="tag">Expected Sale Value:</span> Purchase price compounded by expected annual market growth over the holding period.</div>
      <div class="def"><span class="tag">Loan Payoff @ Exit:</span> Remaining principal outstanding at the time of sale that must be repaid from sale proceeds.</div>
      <div class="def"><span class="tag">Gross Profit (pre-tax):</span> Sale proceeds (after selling costs) ‚àí total upfront cost (COA items) ‚àí NOT including holding/interest. Used only to compute capital gains.</div>
      <div class="def"><span class="tag">Capital Gains Tax:</span> If held &gt;24 months ‚Üí LTCG @20% with indexation (COA √ó CII<sub>sale</sub>/CII<sub>purchase</sub>). Else STCG taxed at slab %.</div>
      <div class="def"><span class="tag">Net Profit:</span> Final net cash from sale (after selling costs, tax and loan payoff) + net cash flows during holding ‚àí total cash invested.</div>
      <div class="def"><span class="tag">ROI:</span> Net Profit √∑ Total Cash Invested.</div>
      <div class="def"><span class="tag">CAGR (simple):</span> \[(Final Net Proceeds √∑ Total Cash Invested)^(1/years) ‚àí 1\].</div>
      <div class="def"><span class="tag">IRR (monthly):</span> Internal rate of return from the full monthly cash flow timeline (EMIs, holding costs, rent, final sale).</div>
      <div class="def"><span class="tag">Profit per Sq Ft:</span> Net Profit √∑ plot size (in sq ft).</div>
    </div>
  </div>

<script>
(function(){
  const el = id => document.getElementById(id);
  const fmt = n => '‚Çπ' + (isFinite(n)? Math.round(n).toLocaleString('en-IN'): '‚Äî');
  const pct = n => (isFinite(n)? n.toFixed(2)+'%':'‚Äî');

  // UI WIRING
  el('state').addEventListener('change',()=>{
    const v=el('state').value.split('|')[1]; el('stampPct').value=Number(v||'7');
  });

  // Modal
  el('defsBtn').onclick = ()=> el('defs').style.display='flex';
  el('defsClose').onclick = ()=> el('defs').style.display='none';
  el('defs').addEventListener('click',e=>{ if(e.target===el('defs')) el('defs').style.display='none' });

  // Utilities
  function toSqft(size,unit){
    if(unit==='sqyard') return size*9;
    if(unit==='sqmeter') return size*10.7639;
    return size;
  }
  function emi(p,annualRate,months){
    const r=(annualRate/100)/12;
    if(r===0) return p/months;
    return p*r*Math.pow(1+r,months)/(Math.pow(1+r,months)-1);
  }
  function irr(cashflows, guess=0.01){
    // monthly IRR (Newton-Raphson)
    let rate=guess, iter=0;
    while(iter++<80){
      let f=0, df=0;
      for(let t=0;t<cashflows.length;t++){
        const cf=cashflows[t];
        const den=Math.pow(1+rate,t);
        f += cf/den;
        df += -t*cf/ (den*(1+rate));
      }
      const newRate = rate - f/df;
      if(!isFinite(newRate)) break;
      if(Math.abs(newRate-rate)<1e-7) return rate;
      rate=newRate;
    }
    return NaN;
  }

  // Core calculation
  function calculate(){
    // Inputs
    const purchasePrice = +el('purchasePrice').value||0;
    const plotSize = +el('plotSize').value||1;
    const plotUnit = el('plotUnit').value;
    const stampPct = (+el('stampPct').value||0)/100;
    const registrationCost = +el('registrationCost').value||0;
    const brokerageBuyPct = (+el('brokerageBuyPct').value||0)/100;
    const legalPurchase = +el('legalPurchase').value||0;
    const miscPurchase = +el('miscPurchase').value||0;
    const gstApplicable = el('gstApplicable').checked;
    const gstPct = (+el('gstPct').value||0)/100;

    const useLoan = el('useLoan').value==='yes';
    const loanAmount = +el('loanAmount').value||0;
    const interestRate = +el('interestRate').value||0;
    const loanTenure = +el('loanTenure').value||0;
    const processingPct = (+el('processingPct').value||0)/100;

    const holdingYears = +el('holdingYears').value||0;
    const propTax = +el('propTax').value||0;
    const maint = +el('maint').value||0;
    const inflationPct = (+el('inflationPct').value||0)/100;
    const growthPct = (+el('growthPct').value||0)/100;
    const sellCostPct = (+el('sellCostPct').value||0)/100;

    const ciiPurchase = +el('ciiPurchase').value||0;
    const ciiSale = +el('ciiSale').value||0;
    const includeCOA = el('includeCostsInCOA').checked;
    const stcgSlab = (+el('stcgSlab').value||0)/100;

    const rentMonthly0 = +el('rentMonthly').value||0;
    const vacancyPct = (+el('vacancyPct').value||0)/100;
    const rentGrowthPct = (+el('rentGrowthPct').value||0)/100;

    // Price per unit
    const ppu = purchasePrice / (plotSize||1);
    el('ppu').textContent = `Price/Unit: ${fmt(ppu).replace('‚Çπ','‚Çπ ')}`;

    // Upfront components
    const stampDuty = purchasePrice*stampPct;
    const brokerageBuy = purchasePrice*brokerageBuyPct;
    const gst = gstApplicable ? purchasePrice*gstPct : 0;
    const processingFee = useLoan ? loanAmount*processingPct : 0;

    const totalUpfront = purchasePrice + stampDuty + registrationCost + brokerageBuy + legalPurchase + miscPurchase + gst + processingFee;
    el('k_upfront').textContent = fmt(totalUpfront);

    // Expected Sale Value (compounded growth)
    const expectedSale = purchasePrice * Math.pow(1+growthPct, holdingYears);
    el('k_sale').textContent = fmt(expectedSale);

    // Loan math (EMIs)
    const months = Math.round(holdingYears*12);
    el('monthsInfo').textContent = `${months} months`;
    let emiVal=0, totalInterestPaid=0, principalOutstanding=0;

    if(useLoan){
      const totalMonths = loanTenure*12;
      emiVal = emi(loanAmount, interestRate, totalMonths);
      el('emiShow').textContent = `EMI: ${fmt(emiVal)}`;
      // Amortize month-by-month until sale
      let bal = loanAmount;
      const r = (interestRate/100)/12;
      for(let m=1;m<=Math.min(months,totalMonths);m++){
        const interest = bal*r;
        const principal = Math.min(emiVal - interest, bal);
        totalInterestPaid += interest;
        bal -= principal;
      }
      principalOutstanding = Math.max(0,bal);
      el('intShow').textContent = `Interest till sale: ${fmt(totalInterestPaid)}`;
    } else {
      el('emiShow').textContent = 'EMI: ‚Äî';
      el('intShow').textContent = 'Interest till sale: ‚Äî';
    }
    el('k_payoff').textContent = fmt(principalOutstanding);

    // Selling costs and proceeds
    const sellingCost = expectedSale*sellCostPct;
    const netSaleBeforeLoanTax = expectedSale - sellingCost;

    // CAPITAL GAINS (market standard)
    // COA (for cap gains) = purchase price + (stamp, regn, purchase brokerage if opted)
    let coa = purchasePrice;
    if(includeCOA){ coa += stampDuty + registrationCost + brokerageBuy; }
    let isLTCG = (holdingYears*12) > 24; // strictly >24 months
    let capGainTax=0, taxMode='‚Äî';
    let indexedCOA = coa;

    if(isLTCG){
      if(ciiPurchase>0 && ciiSale>0){
        indexedCOA = coa * (ciiSale/ciiPurchase);
      }
      const LTCG = Math.max(0, (expectedSale - sellingCost) - indexedCOA);
      capGainTax = 0.20 * LTCG;
      taxMode = `LTCG @20% with indexation (COA indexed ${ciiPurchase||'?'}‚Üí${ciiSale||'?'})`;
    } else {
      const STCG = Math.max(0, (expectedSale - sellingCost) - coa);
      capGainTax = stcgSlab * STCG;
      taxMode = `STCG @${(stcgSlab*100).toFixed(0)}% (held ‚â§24 months)`;
    }
    el('k_tax').textContent = fmt(capGainTax);
    el('k_taxmode').textContent = taxMode;

    // Gross Profit (pre-tax) for display (not used for IRR/ROI directly)
    const grossProfit = (expectedSale - sellingCost) - coa;
    el('k_gross').textContent = fmt(grossProfit);

    // Build monthly cash flow timeline (IRR A)
    const flows=[]; const rows=[];
    const pushRow=(m,cf,why,rb)=>{
      const r=document.createElement('div'); r.className='row';
      const d1=document.createElement('div'); d1.textContent=m;
      const d2=document.createElement('div'); d2.textContent=fmt(cf);
      const d3=document.createElement('div'); d3.textContent=why;
      const d4=document.createElement('div'); d4.textContent=fmt(rb);
      r.append(d1,d2,d3,d4); rows.push(r);
    };
    // Month 0 upfront outflow (cash actually paid by investor at start)
    // If loan used, upfront cash outflow excludes the financed portion of purchase price.
    const upfrontCash =
      (purchasePrice - (useLoan? loanAmount:0)) +
      stampDuty + registrationCost + brokerageBuy + legalPurchase + miscPurchase + gst + processingFee;
    let running = -upfrontCash;
    flows.push(-upfrontCash); pushRow(0, -upfrontCash, 'Upfront cash paid', running);

    // Monthly: EMI (if loan), Property tax + Maintenance (inflated yearly), Rent inflow (after vacancy, growth yearly)
    let annualPT = propTax, annualMT = maint, annualRent = (rentMonthly0*12)*(1 - vacancyPct);
    for(let m=1;m<=months;m++){
      const startOfYear = (m-1)%12===0 && m>1;
      if(startOfYear){
        annualPT *= (1+inflationPct);
        annualMT *= (1+inflationPct);
        annualRent *= (1+rentGrowthPct);
      }
      const monthlyPT = annualPT/12;
      const monthlyMT = annualMT/12;
      let monthCF = -(monthlyPT + monthlyMT);
      let why = 'Property tax + Maintenance';
      if(useLoan){
        monthCF -= emiVal;
        why += ' + EMI';
      }
      // rent inflow
      const monthlyRent = annualRent/12;
      if(monthlyRent>0){
        monthCF += monthlyRent;
        why += ' ‚àí Rent (inflow)';
      }
      flows.push(monthCF); running += monthCF; pushRow(m, monthCF, why, running);
    }

    // Exit month cash: +net sale ‚àí loan payoff ‚àí cap gains tax
    const finalCash = netSaleBeforeLoanTax - principalOutstanding - capGainTax;
    flows.push(finalCash); running += finalCash; pushRow(months+1, finalCash, 'Sale ‚àí costs ‚àí loan payoff ‚àí tax', running);

    // Totals for ROI etc.
    const totalNeg = flows.filter(x=>x<0).reduce((a,b)=>a+b,0);
    const totalPos = flows.filter(x=>x>0).reduce((a,b)=>a+b,0);
    const totalCashInvested = -totalNeg; // positive number
    const netProfit = totalPos - totalCashInvested;

    // ROI / CAGR
    const roi = totalCashInvested>0 ? (netProfit/totalCashInvested)*100 : NaN;
    const finalProceeds = totalPos; // total inflows across holding
    const years = holdingYears;
    const cagr = (totalCashInvested>0 && years>0) ? (Math.pow(finalProceeds/totalCashInvested, 1/years)-1)*100 : NaN;

    // IRR monthly -> annualized
    const mirr = irr(flows, 0.01);
    const airr = isFinite(mirr) ? (Math.pow(1+mirr,12)-1)*100 : NaN;

    // Profit per sqft
    const sqft = toSqft(plotSize, plotUnit);
    const pps = (sqft>0)? netProfit/sqft : NaN;

    // Performance score (friendly)
    let score = 50;
    if(isFinite(airr)){
      if(airr>18) score+=25; else if(airr>14) score+=18; else if(airr>10) score+=10; else if(airr<6) score-=10;
    } else if(isFinite(cagr)){
      if(cagr>15) score+=18; else if(cagr>12) score+=12; else if(cagr<8) score-=8;
    }
    if(netProfit<0) score-=15;
    score = Math.max(0,Math.min(100,score));

    // Paint KPIs
    el('k_totalinv').textContent = fmt(totalCashInvested);
    el('k_net').textContent = fmt(netProfit);
    el('k_roi').textContent = isFinite(roi)? pct(roi):'‚Äî';
    el('k_cagr').textContent = isFinite(cagr)? pct(cagr):'‚Äî';
    el('k_irr').textContent = isFinite(airr)? pct(airr):'‚Äî';
    el('k_pps').textContent = isFinite(pps)? fmt(pps).replace('‚Çπ','‚Çπ '):'‚Äî';
    el('k_score').textContent = score.toFixed(0)+'/100';
    const sb = el('scoreBar'); sb.style.width = score+'%'; sb.textContent = score.toFixed(0)+'%';

    // Positive/negative coloring
    const netBox = el('k_net').parentElement; netBox.classList.remove('pos','neg');
    if(netProfit>=0) netBox.classList.add('pos'); else netBox.classList.add('neg');

    // Render timeline rows
    const holder = el('flowRows'); holder.innerHTML=''; rows.forEach(r=>holder.appendChild(r));

    // Aaria Insights (Style B: crisp, actionable)
    const pros=[], cons=[];
    if(isFinite(airr) && airr>=12) pros.push(`Healthy IRR of ${airr.toFixed(1)}% p.a. beats fixed-income alternatives.`);
    if(growthPct*100>=10) pros.push(`Expected market CAGR ${(growthPct*100).toFixed(1)}% supports appreciation.`);
    if(includeCOA && isLTCG) pros.push(`Indexation reduces taxable gains; indexed COA ‚âà ${fmt(indexedCOA)}.`);
    if(brokerageBuyPct<=0.01) pros.push(`Low purchase brokerage (${(brokerageBuyPct*100).toFixed(1)}%) keeps entry cost tight.`);
    if(sellingCost<=expectedSale*0.02) pros.push(`Lean exit cost (${(sellCostPct*100).toFixed(1)}%).`);

    if(isFinite(airr) && airr<8) cons.push(`IRR only ${isFinite(airr)?airr.toFixed(1):'‚Äî'}% p.a.; consider price negotiation or longer horizon.`);
    if(totalInterestPaid>0 && totalInterestPaid>0.3*purchasePrice) cons.push(`High interest burden till sale (‚âà ${fmt(totalInterestPaid)}).`);
    if(sellCostPct>0.025) cons.push(`Selling costs on the higher side (${(sellCostPct*100).toFixed(1)}%).`);
    if(!isLTCG) cons.push(`Holding ‚â§24 months triggers STCG @ ${(stcgSlab*100).toFixed(0)}%.`);
    if(netProfit<0) cons.push(`Net loss projected. Revisit entry price, growth, or loan mix.`);

    // Ensure at least 3 each
    while(pros.length<3) pros.push('Land is a finite asset; long-term supply scarcity supports prices.');
    while(cons.length<3) cons.push('Real estate is illiquid; emergency exit may need discounts.');

    el('prosList').innerHTML = pros.slice(0,4).map(x=>`<li>${x}</li>`).join('');
    el('consList').innerHTML = cons.slice(0,4).map(x=>`<li>${x}</li>`).join('');

    // Show results
    el('results').style.display='block';

    // Return some values for sharing/PDF
    return {flows, months, airr, cagr, roi, totalCashInvested, netProfit, expectedSale};
  }

  // Share
  el('shareBtn').onclick = async ()=>{
    const text = document.title + ' ‚Äî quick summary generated by AARIA.';
    const url = location.href;
    if(navigator.share){
      try{ await navigator.share({title:document.title,text, url}); }catch{}
    }else{
      navigator.clipboard.writeText(url).then(()=>{
        alert('Link copied to clipboard!');
      });
    }
  };

  // PDF
  el('pdfBtn').onclick = async ()=>{
    const anchor = document.querySelector('.container');
    const { jsPDF } = window.jspdf || {};
    if(!jsPDF){ alert('PDF library not loaded yet. Please try again in a moment.'); return; }

    // Make a quick calc to ensure results visible
    if(el('results').style.display==='none') calculate();

    const canvas = await html2canvas(anchor,{scale:2, useCORS:true, background:'#ffffff'});
    const img = canvas.toDataURL('image/png');
    const pdf = new jsPDF('p','pt','a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = pageWidth;
    const imgHeight = canvas.height * imgWidth / canvas.width;

    let y = 0;
    while(y < imgHeight){
      pdf.addImage(img, 'PNG', 0, -y, imgWidth, imgHeight);
      y += pageHeight;
      if(y < imgHeight) pdf.addPage();
    }
    pdf.save('AARIA_Plot_ROI_Report.pdf');
  };

  // Recalc button
  el('calcBtn').onclick = calculate;

  // Light live updates of a few indicators
  ['purchasePrice','plotSize','plotUnit'].forEach(id=>{
    el(id).addEventListener('input',()=>{
      const purchasePrice=+el('purchasePrice').value||0;
      const size=+el('plotSize').value||1;
      const unit=el('plotUnit').value;
      const ppu=purchasePrice/(size||1);
      el('ppu').textContent=`Price/Unit: ${fmt(ppu).replace('‚Çπ','‚Çπ ')}`;
    });
  });
})();
</script>
</body>
</html>
