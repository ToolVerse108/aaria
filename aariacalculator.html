<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AARIA's Ultimate Plot Investment ROI Calculator ‚Äî Corrected</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px;min-height:100vh}
  .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
  .header{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);color:#fff;padding:30px;text-align:center}
  .header h1{font-size:2.2em;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
  .main-content{padding:24px}
  .tabs{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;padding:0 24px}
  .tab{padding:10px 18px;background:#e7eaf3;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:all .2s;font-size:14px}
  .tab:hover{transform:translateY(-2px)}
  .tab.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
  .tab-content{display:none}
  .tab-content.active{display:block}
  .section{background:#f8f9fa;padding:20px;border-radius:14px;box-shadow:0 4px 6px rgba(0,0,0,.06);margin-bottom:16px}
  .section h2{color:#2a5298;margin-bottom:14px;font-size:1.15em;border-bottom:3px solid #667eea;padding-bottom:6px}
  .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
  .form-group label{display:block;margin-bottom:6px;color:#333;font-weight:600;font-size:13px}
  .form-group input,.form-group select{width:100%;padding:11px;border:2px solid #e3e6ee;border-radius:10px;font-size:15px;transition:border-color .2s,box-shadow .2s;background:#fff}
  .form-group input:focus,.form-group select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
  .helper-text{font-size:12px;color:#666;margin-top:4px;font-style:italic}
  .calculated-field{background:#e8f4f8;padding:10px;border-radius:10px;margin-top:8px;font-weight:700;color:#2a5298}
  .btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:14px 24px;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;transition:transform .15s;width:100%;margin-top:10px}
  .btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(102,126,234,.3)}
  .results{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);padding:24px;border-radius:16px;margin-top:18px}
  .results h2{color:#1e3c72;text-align:center;margin-bottom:22px;font-size:1.6em}
  .results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:18px}
  .result-card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.08);text-align:center;transition:transform .15s}
  .result-card:hover{transform:translateY(-3px)}
  .result-card h3{color:#666;font-size:.85em;margin-bottom:6px;text-transform:uppercase;letter-spacing:.6px}
  .result-card .value{color:#2a5298;font-size:1.5em;font-weight:800;word-break:break-word}
  .result-card.positive .value{color:#27ae60}
  .result-card.negative .value{color:#e74c3c}
  .chart-container{margin:14px 0;padding:16px;background:#fff;border-radius:12px}
  .progress-bar{width:100%;height:36px;background:#e9edf5;border-radius:18px;overflow:hidden;margin:8px 0}
  .progress-fill{height:100%;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);transition:width .8s ease;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:14px}
  .timeline{margin:20px 0;padding:16px;background:#fff;border-radius:12px}
  .timeline-item{display:flex;margin-bottom:12px;padding:12px;background:#f8f9fa;border-radius:10px;border-left:4px solid #667eea}
  .timeline-year{font-weight:800;color:#2a5298;min-width:90px;font-size:15px}
  .comparison-table{width:100%;margin:14px 0;background:#fff;border-radius:12px;overflow:hidden}
  .comparison-table table{width:100%;border-collapse:collapse}
  .comparison-table th{background:#2a5298;color:#fff;padding:12px;text-align:left;font-weight:700}
  .comparison-table td{padding:11px 12px;border-bottom:1px solid #e6eaf2}
  .insight-box{background:#fff3cd;border-left:5px solid #ffc107;padding:16px;margin:14px 0;border-radius:10px}
  .insight-box.success{background:#d4edda;border-left-color:#28a745}
  .insight-box.danger{background:#f8d7da;border-left-color:#dc3545}
  .def-link{display:inline-block;margin:0 0 10px 0;font-size:14px;font-weight:700;color:#2a5298;cursor:pointer;text-decoration:underline}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px;z-index:999}
  .modal-content{max-width:900px;width:100%;max-height:85vh;overflow:auto;background:#fff;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.35);padding:20px}
  .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .modal-title{font-weight:900;color:#2a5298;font-size:18px}
  .close-btn{background:#e9edf5;border:none;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
  .defs-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .def-card{border:1px solid #e6eaf2;border-radius:10px;padding:12px;background:#fafbff}
  .def-card h4{margin-bottom:6px;color:#1e3c72}
  @media (max-width:768px){
    .header h1{font-size:1.7em}
    .results-grid{grid-template-columns:1fr}
  }
 .tip {
  font-size: 12px;
  color: #667eea;
  cursor: help;
  margin-left: 4px;
}
 /* --- MOBILE RESPONSIVENESS FIXES (AARIA PRO UPGRADE) --- */

@media (max-width: 768px) {
  .form-grid { 
    grid-template-columns: 1fr !important;
  }
  .results-grid {
    grid-template-columns: 1fr !important;
  }
  .results-grid .result-card {
    margin-bottom: 12px;
    padding: 14px;
  }
  .modal-content {
    width: 100% !important;
    max-width: 100% !important;
    height: 90vh;
    padding: 14px;
  }
  .modal {
    padding: 0 !important;
  }
  .tabs {
    flex-wrap: wrap;
    justify-content: center;
  }
  .tab {
    flex: 1 1 45%;
    margin-bottom: 6px;
    text-align: center;
  }
  .timeline-item {
    flex-direction: column;
  }
  .comparison-table {
    overflow-x: auto;
    display: block;
  }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>‚úÖ AARIA'S ULTIMATE PLOT INVESTMENT ROI CALCULATOR</h1>
    <p>Your market-standard, India-ready plot investment analyzer</p>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="basic">üìã Basic Inputs</button>
    <button class="tab" data-tab="holding">üí∞ Holding Costs</button>
    <button class="tab" data-tab="growth">üìà Growth Forecast</button>
    <button class="tab" data-tab="exit">üéØ Exit Strategy</button>
    <button class="tab" data-tab="risk">‚ö†Ô∏è Risk Analysis</button>
  </div>

  <div class="main-content">
    <!-- BASIC -->
    <div id="basic" class="tab-content active">
      <div class="section">
        <h2>üèóÔ∏è Plot Details</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>Purchase Price (‚Çπ)</label>
            <input type="number" id="purchasePrice" value="5000000" />
            <div class="helper-text">Sale deed value / agreement value</div>
          </div>
          <div class="form-group">
            <label>Plot Size</label>
            <input type="number" id="plotSize" value="1000" />
          </div>
          <div class="form-group">
            <label>Unit</label>
            <select id="plotUnit">
              <option value="sqft" selected>Square Feet</option>
              <option value="sqyard">Square Yards</option>
              <option value="sqmeter">Square Meters</option>
            </select>
          </div>
          <div class="form-group">
            <label>Circle Rate (‚Çπ per unit)</label>
            <input type="number" id="circleRate" value="4500"/>
            <div class="helper-text">Govt. minimum (guidance) value</div>
          </div>
        </div>
        <div class="calculated-field">
          Price per unit: ‚Çπ<span id="pricePerUnit">0</span> |
          <span id="circleRateComparison"></span>
        </div>
      </div>

      <div class="section">
        <h2>üí∞ Purchase Costs & Registration</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>State (Stamp Duty)</label>
            <select id="state">
              <option value="up">Uttar Pradesh (7%)</option>
              <option value="mh">Maharashtra (5.5%)</option>
              <option value="dl">Delhi (6%)</option>
              <option value="ka">Karnataka (5%)</option>
              <option value="tn">Tamil Nadu (7%)</option>
              <option value="rj">Rajasthan (5.5%)</option>
              <option value="gj">Gujarat (4.9%)</option>
              <option value="hr">Haryana (6.5%)</option>
              <option value="mp">Madhya Pradesh (7.5%)</option>
              <option value="pb">Punjab (7%)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Registration Cost (‚Çπ)</label>
            <input type="number" id="registrationCost" value="10000"/>
            <div class="helper-text">Often ~1% (varies)</div>
          </div>
          <div class="form-group">
            <label>GST Applicable?</label>
            <select id="gstApplicable">
              <option value="no" selected>No</option>
              <option value="yes">Yes (on under-construction)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Brokerage (%)</label>
            <input type="number" id="brokerage" value="1" step="0.1" min="0" max="5"/>
          </div>
          <div class="form-group">
            <label>Lawyer/Consultancy Fees (‚Çπ)</label>
            <input type="number" id="lawyerFees" value="25000"/>
          </div>
          <div class="form-group">
            <label>Other Misc Costs (‚Çπ)</label>
            <input type="number" id="miscCosts" value="10000"/>
            <div class="helper-text">Site visits, documentation, etc.</div>
          </div>
        </div>
        <div class="calculated-field">
          Stamp Duty: ‚Çπ<span id="stampDutyCalc">0</span> |
          Brokerage: ‚Çπ<span id="brokerageCalc">0</span> |
          <strong>Total Upfront Cash (w/o loan): ‚Çπ<span id="totalUpfrontPreview">0</span></strong>
        </div>
      </div>
    </div>

    <!-- HOLDING -->
    <div id="holding" class="tab-content">
      <div class="section">
        <h2>üè¶ Loan Details</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>Taking Loan?</label>
            <select id="loanTaken">
              <option value="no" selected>No (Cash Purchase)</option>
              <option value="yes">Yes (Home/Plot Loan)</option>
            </select>
          </div>
        </div>
        <div id="loanFields" style="display:none;">
          <div class="form-grid">
            <div class="form-group">
              <label>Loan Amount (‚Çπ)</label>
              <input type="number" id="loanAmount" value="3000000"/>
              <div class="helper-text">Usually ‚â§ 80% of value</div>
            </div>
            <div class="form-group">
              <label>Interest Rate (% p.a.)</label>
              <input type="number" id="interestRate" value="9.5" step="0.1"/>
            </div>
            <div class="form-group">
              <label>Loan Tenure (years)</label>
              <input type="number" id="loanTenure" value="10" min="1" max="30"/>
            </div>
            <div class="form-group">
              <label>Processing Fee (%)</label>
              <input type="number" id="processingFeePercent" value="0.5" step="0.1"/>
            </div>
          </div>
          <div class="calculated-field">
            Monthly EMI: ‚Çπ<span id="emiCalc">0</span> |
            Total Interest (till sale): ‚Çπ<span id="totalInterestCalc">0</span> |
            Processing Fee: ‚Çπ<span id="processingFeeCalc">0</span> |
            Remaining Loan at Sale: ‚Çπ<span id="loanBalanceAtSale">0</span>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>üìÖ Annual Holding Costs</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>Annual Property Tax (‚Çπ)</label>
            <input type="number" id="propertyTax" value="5000"/>
          </div>
          <div class="form-group">
            <label>Annual Maintenance (‚Çπ)</label>
            <input type="number" id="maintenance" value="12000"/>
          </div>
          <div class="form-group">
            <label>Inflation Rate for Costs (%)</label>
            <input type="number" id="inflationRate" value="6" step="0.1"/>
          </div>
          <div class="form-group">
            <label>Opportunity Cost (% p.a.)</label>
            <input type="number" id="opportunityCost" value="0" step="0.1"/>
            <div class="helper-text">Info only; not used in ROI</div>
          </div>
        </div>
      </div>
    </div>

    <!-- GROWTH -->
    <div id="growth" class="tab-content">
      <div class="section">
        <h2>üìà Market Growth Projections</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>Forecasted Growth Rate (% p.a.)</label>
            <input type="number" id="forecastedGrowth" value="10" step="0.5"/>
          </div>
          <div class="form-group">
            <label>Growth Model</label>
            <select id="growthModel">
              <option value="compound" selected>Compound (standard)</option>
              <option value="linear">Linear (conservative)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Market Cycle Multiplier</label>
            <select id="marketCycle">
              <option value="0.9">Soft Market</option>
              <option value="1" selected>Neutral</option>
              <option value="1.1">Rising Market</option>
            </select>
          </div>
          <div class="form-group">
            <label>Infra/Legal/Demand Multiplier (combined)</label>
            <select id="combinedMultiplier">
              <option value="0.95">Below Average</option>
              <option value="1" selected>Average</option>
              <option value="1.05">Above Average</option>
              <option value="1.1">Strong Drivers</option>
            </select>
            <div class="helper-text">Applies to growth, capped to market-realistic band</div>
          </div>
        </div>
      </div>
    </div>

    <!-- EXIT -->
    <div id="exit" class="tab-content">
      <div class="section">
        <h2>üéØ Exit Planning & Timeline</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>Holding Period (years)</label>
            <input type="number" id="holdingPeriod" value="5" min="1" max="30"/>
          </div>
          <div class="form-group">
            <label>Exit Strategy</label>
            <select id="exitStrategy">
              <option value="normal" selected>Normal Market Sale</option>
              <option value="quick">Quick Sale (‚àí10%)</option>
              <option value="distress">Distress (‚àí20%)</option>
              <option value="premium">Premium (+5%)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Capital Gains Tax Scenario</label>
            <select id="capitalGainsTax">
              <option value="20" selected>Long Term (‚â• 24 months): 20%</option>
              <option value="30">Short Term (&lt; 24 months): 30% (slab approx)</option>
              <option value="0">Reinvest (Sec 54F assumed): 0%</option>
            </select>
          </div>
          <div class="form-group">
            <label>Selling Costs (%)</label>
            <input type="number" id="sellingCosts" value="2" step="0.5"/>
            <div class="helper-text">Brokerage, legal fees at time of sale</div>
          </div>
         <div class="form-group">
  <label>Run Sensitivity Analysis?</label>
  <select id="sensitivityMode">
    <option value="off" selected>No</option>
    <option value="on">Yes (¬±3% Growth Variation)</option>
  </select>
  <div class="helper-text">
    Shows best & worst case CAGR projection.
  </div>
</div>
        </div>
      </div>

      <div class="section">
        <h2>üèóÔ∏è Optional: Construction & Rent</h2>
        <div class="form-group">
          <label>Plan to Construct & Rent?</label>
          <select id="planConstruct">
            <option value="no" selected>No - Sell Plot As-Is</option>
            <option value="yes">Yes - Build & Rent Out</option>
          </select>
        </div>
        <div id="constructionFields" style="display:none;">
          <div class="form-grid">
            <div class="form-group">
              <label>Construction Cost (‚Çπ per sq ft)</label>
              <input type="number" id="constructionCostPerSqft" value="1500"/>
            </div>
            <div class="form-group">
              <label>Built-up Area (sq ft)</label>
              <input type="number" id="builtupArea" value="1500"/>
            </div>
            <div class="form-group">
              <label>Expected Monthly Rent (‚Çπ)</label>
              <input type="number" id="monthlyRent" value="25000"/>
            </div>
            <div class="form-group">
              <label>Vacancy Rate (% of year)</label>
              <input type="number" id="vacancyRate" value="10" step="1"/>
            </div>
            <div class="form-group">
              <label>Annual Property Maintenance for Rental (‚Çπ)</label>
              <input type="number" id="rentalMaintenance" value="30000"/>
            </div>
            <div class="form-group">
              <label>Rent Growth Rate (% p.a.)</label>
              <input type="number" id="rentGrowth" value="5" step="0.5"/>
            </div>
          </div>
          <div class="calculated-field">
            Total Construction Cost: ‚Çπ<span id="totalConstructionCost">0</span> |
            Year-1 Net Rent: ‚Çπ<span id="annualRent">0</span> |
            Rental Yield (Yr-1): <span id="rentalYield">0</span>%
          </div>
        </div>
      </div>
    </div>

    <!-- RISK -->
    <div id="risk" class="tab-content">
      <div class="section">
        <h2>‚ö†Ô∏è Simple Risk Toggles (applied in growth multiplier)</h2>
        <div class="form-grid">
          <div class="form-group">
            <label>Sales Velocity</label>
            <select id="salesVelocity">
              <option value="0.98">Slow</option>
              <option value="1" selected>Moderate</option>
              <option value="1.02">Fast</option>
            </select>
          </div>
          <div class="form-group">
            <label>Documentation Grade</label>
            <select id="docGrade">
              <option value="0.98">Issues</option>
              <option value="1" selected>Standard</option>
              <option value="1.02">Premium</option>
            </select>
          </div>
          <div class="form-group">
            <label>Macro Environment</label>
            <select id="macro">
              <option value="0.98">Weak</option>
              <option value="1" selected>Neutral</option>
              <option value="1.02">Strong</option>
            </select>
          </div>
        </div>
        <div class="helper-text">These nudge the combined multiplier subtly to prevent unrealistic projections.</div>
      </div>
    </div>

    <button class="btn" id="calcBtn">üöÄ Calculate Complete Investment Analysis</button>
    <div class="def-link" id="openDefs">üìò Definitions of all terms</div>

    <!-- RESULTS -->
    <div id="resultsSection" class="results" style="display:none;">
      <h2>üìä Complete Investment Analysis Report</h2>

      <div class="results-grid">
        <div class="result-card">
          <h3>Total Upfront Cash</h3>
          <div class="value" id="totalUpfrontCash">‚Çπ0</div>
          <div style="font-size:12px;margin-top:6px;color:#666">Down payment + purchase costs (+ processing fee if loan)</div>
        </div>
        <div class="result-card">
          <h3>Total Investment</h3>
          <div class="value" id="totalInvestment">‚Çπ0</div>
          <div style="font-size:12px;margin-top:6px;color:#666">All cash outflows over holding</div>
        </div>
        <div class="result-card positive">
          <h3>Expected Sale Value</h3>
          <div class="value" id="expectedValue">‚Çπ0</div>
          <div style="font-size:12px;margin-top:6px;color:#666">After <span id="yearsHeld">5</span> years</div>
        </div>
        <div class="result-card">
          <h3>Capital Gain (for tax)</h3>
          <div class="value" id="capitalGainForTax">‚Çπ0</div>
          <div style="font-size:12px;margin-top:6px;color:#666">Sale ‚àí eligible costs ‚àí selling expenses</div>
        </div>
        <div class="result-card">
          <h3>Capital Gains Tax</h3>
          <div class="value" id="taxAmount">‚Çπ0</div>
          <div style="font-size:12px;margin-top:6px;color:#666">Approx as per selection</div>
        </div>
        <div class="result-card">
          <h3>Net Sale Proceeds</h3>
          <div class="value" id="netSaleProceeds">‚Çπ0</div>
          <div style="font-size:12px;margin-top:6px;color:#666">After selling costs, tax & loan payoff</div>
        </div>
        <div class="result-card">
          <h3>Net Profit</h3>
          <div class="value" id="netProfit">‚Çπ0</div>
          <div style="font-size:12px;margin-top:6px;color:#666">Proceeds ‚àí Total Investment</div>
        </div>
        <div class="result-card">
          <h3>ROI</h3>
          <div class="value" id="roiPercent">0%</div>
          <div style="font-size:12px;margin-top:6px;color:#666">Return on Investment</div>
        </div>
        <div class="result-card">
          <h3>CAGR</h3>
          <div class="value" id="cagr">0%</div>
          <div style="font-size:12px;margin-top:6px;color:#666">Annualised (cash-on-cash)</div>
        </div>
        <div class="result-card">
          <h3>Profit per Sq Ft</h3>
          <div class="value" id="profitPerSqft">‚Çπ0</div>
          <div style="font-size:12px;margin-top:6px;color:#666">Unit economics</div>
        </div>
      </div>

      <div class="chart-container">
        <h3 style="margin-bottom:10px;">üìà Overall Investment Performance Score</h3>
        <div class="progress-bar"><div class="progress-fill" id="performanceScore" style="width:0%">0%</div></div>
        <div id="performanceText" style="margin-top:8px;text-align:center;color:#555;font-size:14px;"></div>
      </div>

      <div class="timeline">
        <h3 style="margin-bottom:12px;color:#2a5298;">üìÖ Year-wise Value Projection</h3>
        <div id="yearlyBreakdown"></div>
      </div>

      <div class="comparison-table">
        <h3 style="padding:14px;color:#2a5298;background:#f8f9fa;">üìä Benchmark Comparison</h3>
        <table>
          <thead>
            <tr><th>Investment Type</th><th>Returns (CAGR)</th><th>Comparison</th></tr>
          </thead>
          <tbody id="comparisonTable"></tbody>
        </table>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:14px;">
        <div class="insight-box success">
          <h3>‚úÖ Top Investment Strengths</h3>
          <ul id="proslist"></ul>
        </div>
        <div class="insight-box danger">
          <h3>‚ö†Ô∏è Key Risk Factors</h3>
          <ul id="conslist"></ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Definitions Modal -->
<div class="modal" id="defsModal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="defsTitle">
    <div class="modal-header">
      <div class="modal-title" id="defsTitle">üìò Definitions (Tap to learn each term)</div>
      <button class="close-btn" id="closeDefs">Close</button>
    </div>
    <div class="defs-grid" id="defsGrid">
      <!-- definitions injected by JS -->
    </div>
  </div>
</div>

<script>
/* ---------- Helpers ---------- */
const fmt = (n, maxDigits=0)=> isFinite(n) ? n.toLocaleString('en-IN',{maximumFractionDigits:maxDigits}) : '0';
const el = id => document.getElementById(id);
const getNum = id => parseFloat(el(id).value)||0;

const STAMP = {up:.07,mh:.055,dl:.06,ka:.05,tn:.07,rj:.055,gj:.049,hr:.065,mp:.075,pb:.07};

function unitToSqft(value, unit){
  if(unit==='sqyard') return value*9;
  if(unit==='sqmeter') return value*10.76391041671;
  return value;
}

/* ---------- Tabs ---------- */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    el(t.dataset.tab).classList.add('active');
    liveUpdates();
  });
});

/* ---------- Show/Hide groups ---------- */
function toggleLoanFields(){
  const show = el('loanTaken').value==='yes';
  el('loanFields').style.display = show ? 'block' : 'none';
}
function toggleConstructionFields(){
  const show = el('planConstruct').value==='yes';
  el('constructionFields').style.display = show ? 'block' : 'none';
}

/* ---------- Live previews ---------- */
function liveUpdates(){
  const purchasePrice = getNum('purchasePrice');
  const plotSize = getNum('plotSize')||1;
  const circleRate = getNum('circleRate');
  const plotUnit = el('plotUnit').value;

  const pricePerUnit = purchasePrice/plotSize;
  el('pricePerUnit').textContent = fmt(pricePerUnit);

  const cmpPct = circleRate>0 ? ((pricePerUnit/circleRate)-1)*100 : 0;
  el('circleRateComparison').innerHTML = circleRate>0
    ? (cmpPct>0
      ? `<span style="color:#dc3545;">Above circle rate by ${cmpPct.toFixed(1)}%</span>`
      : `<span style="color:#27ae60;">Below circle rate by ${Math.abs(cmpPct).toFixed(1)}%</span>`)
    : '';

  const state = el('state').value;
  const stampDuty = purchasePrice*(STAMP[state]||0);
  el('stampDutyCalc').textContent = fmt(stampDuty);

  const brokerage = getNum('brokerage');
  const brokerageCost = purchasePrice*(brokerage/100);
  el('brokerageCalc').textContent = fmt(brokerageCost);

  const registrationCost = getNum('registrationCost');
  const lawyerFees = getNum('lawyerFees');
  const miscCosts = getNum('miscCosts');
  const gst = el('gstApplicable').value==='yes' ? purchasePrice*0.12 : 0;

  // Upfront cash (no loan): purchase price + all purchase costs
  const upfrontNoLoan = purchasePrice + stampDuty + registrationCost + gst + brokerageCost + lawyerFees + miscCosts;
  el('totalUpfrontPreview').textContent = fmt(upfrontNoLoan);

  // Loan live preview
  if(el('loanTaken').value==='yes'){
    const loanAmount = getNum('loanAmount');
    const r = (getNum('interestRate')/100)/12;
    const n = Math.max(1,getNum('loanTenure')*12);
    const emi = r>0 ? loanAmount * r * Math.pow(1+r,n) / (Math.pow(1+r,n)-1) : loanAmount/n;
    el('emiCalc').textContent = fmt(emi);

    // Assume holding period for preview
    const holdYrs = Math.max(1,getNum('holdingPeriod'));
    const m = Math.min(holdYrs*12,n);

    let balance = loanAmount, totalInt=0;
    for(let i=0;i<m;i++){
      const interest = balance*r;
      const principal = emi - interest;
      totalInt += interest;
      balance -= principal;
    }
    el('totalInterestCalc').textContent = fmt(totalInt);
    const procFee = loanAmount*(getNum('processingFeePercent')/100);
    el('processingFeeCalc').textContent = fmt(procFee);
    el('loanBalanceAtSale').textContent = fmt(Math.max(0,balance));
  }

  // Construction live preview
  if(el('planConstruct').value==='yes'){
    const cc = getNum('constructionCostPerSqft');
    const bua = getNum('builtupArea');
    const totalCC = cc*bua;
    const monthlyRent = getNum('monthlyRent');
    const vacancy = getNum('vacancyRate');
    const annualRent = monthlyRent*12*(1 - vacancy/100);
    const rentalYield = (annualRent / Math.max(1,(purchasePrice+totalCC))) * 100;
    el('totalConstructionCost').textContent = fmt(totalCC);
    el('annualRent').textContent = fmt(annualRent);
    el('rentalYield').textContent = rentalYield.toFixed(2);
  }

  toggleLoanFields();
  toggleConstructionFields();
}

/* ---------- Core Calculation ---------- */
function calculate(){
  const purchasePrice = getNum('purchasePrice');
  const plotSize = getNum('plotSize')||1;
  const plotUnit = el('plotUnit').value;
  const plotSizeSqft = unitToSqft(plotSize, plotUnit);

  const registrationCost = getNum('registrationCost');
  const lawyerFees = getNum('lawyerFees');
  const miscCosts = getNum('miscCosts');
  const brokeragePct = getNum('brokerage');

  const state = el('state').value;
  const stampDuty = purchasePrice*(STAMP[state]||0);
  const gst = el('gstApplicable').value==='yes' ? purchasePrice*0.12 : 0;
  const brokerageCost = purchasePrice*(brokeragePct/100);

  // Optional construction (treated as "improvement" for tax + increases cash invested)
  const planConstruct = el('planConstruct').value==='yes';
  const totalConstructionCost = planConstruct ? getNum('constructionCostPerSqft')*getNum('builtupArea') : 0;

  // Loan
  const loanTaken = el('loanTaken').value==='yes';
  const loanAmount = loanTaken ? getNum('loanAmount') : 0;
  const interestRate = loanTaken ? getNum('interestRate') : 0;
  const loanTenure = loanTaken ? getNum('loanTenure') : 0;
  const processingFee = loanTaken ? loanAmount*(getNum('processingFeePercent')/100) : 0;

  // Holding & exit
  const propertyTax = getNum('propertyTax');
  const maintenance = getNum('maintenance');
  const inflationRate = getNum('inflationRate');
  const holdingPeriod = Math.max(1,getNum('holdingPeriod'));
  const exitStrategy = el('exitStrategy').value;
  const capitalGainsTaxRate = parseFloat(el('capitalGainsTax').value)||0;
  const sellingCostsPct = getNum('sellingCosts');

  // Growth (market-standard with bounded multipliers)
  const baseGrowth = getNum('forecastedGrowth')/100;               // as decimal
  const marketCycle = parseFloat(el('marketCycle').value)||1;
  const combinedMultiplierBase = parseFloat(el('combinedMultiplier').value)||1;
  const riskNudges = (parseFloat(el('salesVelocity').value)||1) * (parseFloat(el('docGrade').value)||1) * (parseFloat(el('macro').value)||1);
  // multiply but keep within 0.8x .. 1.3x to avoid unrealistic compounding
  const combinedMultiplier = Math.min(1.3, Math.max(0.8, combinedMultiplierBase * riskNudges));
  let adjGrowth = baseGrowth * combinedMultiplier * marketCycle;
  // cap annual growth between -20% and +25% for realism
  adjGrowth = Math.min(0.25, Math.max(-0.20, adjGrowth));

  const growthModel = el('growthModel').value;

  // Expected value path
  let expectedValue = purchasePrice;
  const yearlyValues = [];
  if(growthModel==='linear'){
    expectedValue = purchasePrice * (1 + adjGrowth*holdingPeriod);
    for(let i=1;i<=holdingPeriod;i++){
      yearlyValues.push({year:i, value: purchasePrice*(1 + adjGrowth*i)});
    }
  }else{
    expectedValue = purchasePrice * Math.pow(1+adjGrowth, holdingPeriod);
    for(let i=1;i<=holdingPeriod;i++){
      yearlyValues.push({year:i, value: purchasePrice*Math.pow(1+adjGrowth, i)});
    }
  }

  // Exit strategy adjustments
  if(exitStrategy==='quick') expectedValue *= 0.90;
  else if(exitStrategy==='distress') expectedValue *= 0.80;
  else if(exitStrategy==='premium') expectedValue *= 1.05;

  // Selling costs
  const sellingExpense = expectedValue * (sellingCostsPct/100);

  /* ====== CAPITAL GAINS (for tax) ======
     Capital Gain ‚âà Sale Price ‚àí (Eligible Acquisition & Improvement Costs) ‚àí Selling Expense
     Eligible costs: purchase price + stamp duty + registration + brokerage + lawyer + misc + GST + construction (if any)
     (We do not subtract holding costs/interest here for tax calculation.)
  */
  const acquisitionForTax = purchasePrice + stampDuty + registrationCost + brokerageCost + lawyerFees + miscCosts + gst + totalConstructionCost;
  const capitalGainForTax = expectedValue - sellingExpense - acquisitionForTax;
  const taxAmount = capitalGainForTax>0 ? capitalGainForTax*(capitalGainsTaxRate/100) : 0;

  /* ====== LOAN AMORTIZATION ====== */
  let totalInterestPaid = 0, loanBalance = 0, emi=0;
  if(loanTaken){
    const r = (interestRate/100)/12;
    const n = Math.max(1, loanTenure*12);
    emi = r>0 ? loanAmount * r * Math.pow(1+r,n) / (Math.pow(1+r,n)-1) : loanAmount/n;
    const m = Math.min(holdingPeriod*12, n);
    loanBalance = loanAmount;
    for(let i=0;i<m;i++){
      const interest = loanBalance*r;
      const principal = emi - interest;
      totalInterestPaid += interest;
      loanBalance -= principal;
    }
    loanBalance = Math.max(0, loanBalance);
  }

  /* ====== CASH INVESTED (MARKET-STANDARD) ======
     Total Upfront Cash:
       If loan: down payment + stamp + registration + GST + brokerage + lawyer + misc + processing fee + (construction if done upfront)
       If no loan: purchase price + all the above costs (+ construction)
     Total Holding Costs:
       Property tax + maintenance escalated for each year
     Total Interest Paid (till sale) is included in Total Investment (cash outflow)
     Opportunity cost is NOT included (only informational)
  */
  const downPayment = loanTaken ? Math.max(0, purchasePrice - loanAmount) : purchasePrice;
  const upfrontPurchaseCosts = stampDuty + registrationCost + gst + brokerageCost + lawyerFees + miscCosts;
  const upfrontConstruction = planConstruct ? totalConstructionCost : 0;
  const totalUpfrontCash = downPayment + upfrontPurchaseCosts + (loanTaken ? processingFee : 0) + upfrontConstruction;

  // Holding costs (inflation escalated)
  let totalHoldingCost = 0;
  for(let y=1;y<=holdingPeriod;y++){
    totalHoldingCost += (propertyTax + maintenance) * Math.pow(1 + (getNum('inflationRate')/100), y-1);
  }

  // Rental income (optional, offsets holding; simple model with growth)
  let totalRentNet = 0;
  if(planConstruct){
    const monthlyRent = getNum('monthlyRent');
    const vacancy = getNum('vacancyRate');
    const rentGrowth = getNum('rentGrowth')/100;
    const annualMaintRent = getNum('rentalMaintenance');
    let yearRent = monthlyRent*12*(1 - vacancy/100) - annualMaintRent;
    for(let y=1;y<=holdingPeriod;y++){
      totalRentNet += yearRent;
      yearRent *= (1 + rentGrowth);
    }
  }

  // Total cash invested over holding (cash outflow minus rent inflow)
  const totalInvestment = totalUpfrontCash + totalHoldingCost + totalInterestPaid - totalRentNet;

  /* ====== NET SALE PROCEEDS (to investor) ======
     Proceeds after: selling costs, tax, and loan payoff (if any)
  */
  const netSaleProceeds = expectedValue - sellingExpense - taxAmount - (loanTaken ? loanBalance : 0);

  /* ====== RESULTS ====== */
  const netProfit = netSaleProceeds - totalInvestment;
  const roiPercent = totalInvestment>0 ? (netProfit/totalInvestment)*100 : 0;
  const cagr = (totalInvestment>0 && holdingPeriod>0)
    ? (Math.pow(netSaleProceeds/totalInvestment, 1/holdingPeriod) - 1)*100
    : 0;
  const profitPerSqft = plotSizeSqft>0 ? netProfit/plotSizeSqft : 0;

  // UI bind
  el('totalUpfrontCash').textContent = '‚Çπ'+fmt(totalUpfrontCash);
  el('totalInvestment').textContent  = '‚Çπ'+fmt(totalInvestment);
  el('expectedValue').textContent    = '‚Çπ'+fmt(expectedValue);
  el('yearsHeld').textContent        = holdingPeriod;
  el('capitalGainForTax').textContent= '‚Çπ'+fmt(capitalGainForTax);
  el('taxAmount').textContent        = '‚Çπ'+fmt(taxAmount);
  el('netSaleProceeds').textContent  = '‚Çπ'+fmt(netSaleProceeds);
  el('netProfit').textContent        = '‚Çπ'+fmt(netProfit);
  el('roiPercent').textContent       = (isFinite(roiPercent)?roiPercent:0).toFixed(2)+'%';
  el('cagr').textContent             = (isFinite(cagr)?cagr:0).toFixed(2)+'%';
  el('profitPerSqft').textContent    = '‚Çπ'+fmt(profitPerSqft);

  // Performance score (simple)
  const perf = Math.min(100, Math.max(0, 50 + ((cagr-10)*3)));
  const pf = el('performanceScore');
  pf.style.width = perf.toFixed(0)+'%';
  pf.textContent = perf.toFixed(0)+'%';
  el('performanceText').textContent =
    perf>=85?'Outstanding üåü':
    perf>=70?'Excellent üëç':
    perf>=55?'Good üòä':
    perf>=40?'Average üòê':'Below Expectations üòü';

  // Yearly breakdown
  let yHTML = '';
  yearlyValues.forEach(v=>{
    const growthPct = ((v.value/purchasePrice)-1)*100;
    yHTML += `
      <div class="timeline-item">
        <div class="timeline-year">Year ${v.year}</div>
        <div style="flex:1">
          <div style="font-size:1.1em;font-weight:800;color:#2a5298;">‚Çπ${fmt(v.value)}</div>
          <div style="color:#27ae60;margin-top:4px;">${growthPct>=0?'+':''}${growthPct.toFixed(1)}% from purchase</div>
        </div>
      </div>
    `;
  });
  el('yearlyBreakdown').innerHTML = yHTML;

  // Comparison table (illustrative)
  const cagrVal = isFinite(cagr)?cagr:0;
  const comps = [
    {type:'Your Plot Investment', cagr:cagrVal, key:true},
    {type:'Gold (long-term)', cagr:9},
    {type:'Fixed Deposit', cagr:6.5},
    {type:'Nifty 50 (LT avg)', cagr:12},
    {type:'RE (India avg)', cagr:8.5}
  ];
  el('comparisonTable').innerHTML = comps.map(row=>{
    const comp = row.key ? '‚Äî' :
      (cagrVal>row.cagr
        ? `<span style="color:#27ae60;">Better by ${(cagrVal-row.cagr).toFixed(1)}%</span>`
        : `<span style="color:#e74c3c;">Lower by ${(row.cagr-cagrVal).toFixed(1)}%</span>`);
    return `<tr>
      <td style="font-weight:${row.key?'800':'500'}">${row.type}</td>
      <td style="font-weight:800">${row.cagr.toFixed(2)}%</td>
      <td>${comp}</td>
    </tr>`;
  }).join('');

  // Pros/Cons quick list
  const pros=[], cons=[];
  if(cagrVal>12) pros.push('Strong annualised return (CAGR) vs common benchmarks');
  if(roiPercent>60) pros.push('Healthy cash-on-cash ROI over holding period');
  if(totalRentNet>0) pros.push('Rental inflow offsets holding/interest costs');
  if(planConstruct && totalConstructionCost>0) pros.push('Improvement adds value and tax basis');

  if(cagrVal<8) cons.push('Projected CAGR near/below real estate averages');
  if(totalInterestPaid>0 && roiPercent<12) cons.push('Loan interest burden pressurises returns');
  if(sellingExpense/expectedValue>0.03) cons.push('High exit costs reduce net proceeds');
  if(capitalGainForTax<=0) cons.push('Low/negative capital gain after eligible costs & selling');

  el('proslist').innerHTML = pros.slice(0,3).map(p=>`<li>${p}</li>`).join('') || '<li>Real estate offers inflation hedge</li>';
  el('conslist').innerHTML = cons.slice(0,3).map(c=>`<li>${c}</li>`).join('') || '<li>Real estate is relatively illiquid</li>';

  // Color cues
  const cards = document.querySelectorAll('.result-card');
  cards.forEach(c=>c.classList.remove('positive','negative'));
  const netProfitCard = el('netProfit').closest('.result-card');
  if(netProfit>0) netProfitCard.classList.add('positive'); else netProfitCard.classList.add('negative');
}

/* ---------- Definitions Modal ---------- */
const DEFINITIONS = [
  {t:'Total Upfront Cash', d:'All cash you pay at purchase. If loan: Down payment + stamp duty + registration + GST (if any) + brokerage + lawyer + misc + processing fee + construction (if built upfront). If no loan: Purchase price + these costs (+ construction).'},
  {t:'Total Investment', d:'Total cash outflows over the holding period: Total Upfront Cash + inflation-adjusted property tax & maintenance + loan interest paid (till sale) ‚àí total net rent received (if any).'},
  {t:'Expected Sale Value', d:'Projected sale price after your holding period, based on your growth settings and exit strategy (quick/premium, etc.).'},
  {t:'Selling Costs', d:'Costs paid at sale (brokerage, legal, etc.) as a % of sale price.'},
  {t:'Capital Gain (for tax)', d:'Sale price ‚àí eligible acquisition & improvement costs (purchase price, stamp duty, registration, brokerage, lawyer, misc, GST, construction) ‚àí selling expenses. Used only to estimate capital gains tax.'},
  {t:'Capital Gains Tax', d:'Estimated tax on capital gain based on your selected scenario (LT 20%, ST 30% approximate, or reinvest @ 0%). Indexation is not modelled here.'},
  {t:'Net Sale Proceeds', d:'Money you actually take home at sale after: selling costs, capital gains tax, and paying off any remaining loan balance.'},
  {t:'Net Profit', d:'Net Sale Proceeds ‚àí Total Investment (all the cash you put in over time).'},
  {t:'ROI', d:'Return on Investment = Net Profit √∑ Total Investment.'},
  {t:'CAGR', d:'Annualised cash-on-cash return ‚âà [(Net Sale Proceeds √∑ Total Investment)^(1/years)] ‚àí 1.'},
  {t:'Profit per Sq Ft', d:'Net Profit √∑ plot area (in square feet).'},
  {t:'Price per Unit', d:'Purchase price √∑ plot size (in your selected unit).'},
  {t:'Circle Rate', d:'Government-notified minimum value per unit for stamp duty purposes; varies by locality.'}
];

function buildDefs(){
  el('defsGrid').innerHTML = DEFINITIONS.map(def=>`
    <div class="def-card">
      <h4>${def.t}</h4>
      <p style="font-size:14px;line-height:1.55;color:#333">${def.d}</p>
    </div>
  `).join('');
}
function openDefs(){ el('defsModal').style.display='flex'; }
function closeDefs(){ el('defsModal').style.display='none'; }

/* ---------- Events ---------- */
['purchasePrice','plotSize','circleRate','plotUnit','state','registrationCost','gstApplicable','brokerage','lawyerFees','miscCosts',
 'loanTaken','loanAmount','interestRate','loanTenure','processingFeePercent','propertyTax','maintenance','inflationRate',
 'forecastedGrowth','growthModel','marketCycle','combinedMultiplier','salesVelocity','docGrade','macro',
 'holdingPeriod','exitStrategy','capitalGainsTax','sellingCosts','planConstruct','constructionCostPerSqft','builtupArea','monthlyRent','vacancyRate','rentalMaintenance','rentGrowth'
].forEach(id=>{
  const node = el(id);
  if(node){ node.addEventListener('input', liveUpdates); node.addEventListener('change', liveUpdates); }
});

el('calcBtn').addEventListener('click', ()=>{
  calculate();
  el('resultsSection').style.display='block';
  el('resultsSection').scrollIntoView({behavior:'smooth', block:'start'});
});

el('openDefs').addEventListener('click', ()=>{ buildDefs(); openDefs(); });
el('closeDefs').addEventListener('click', closeDefs);
window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDefs(); });
el('defsModal').addEventListener('click', (e)=>{ if(e.target.id==='defsModal') closeDefs(); });

/* ---------- Init ---------- */
window.onload = () => { liveUpdates(); };
</script>
</body>
</html>
