<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Aaria • Growth Forecast Mapping Tool</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Leaflet & plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- Turf -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <!-- Export libs -->
  <script src="https://cdn.jsdelivr.net/gh/eligrey/FileSaver.js/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    html{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    :root{--brand:#2d7efb}
    body{background:#0b1220;color:#e6eef8}
    #map{height: calc(100vh - 220px); border-radius: 12px; overflow: hidden}
    .leaflet-container{background:#020214}
    .legend{background:#0f1724;color:#cbd5e1;padding:.5rem .75rem;border-radius:.75rem;border:1px solid #1f2937}
    .legend .swatch{display:inline-block;width:14px;height:14px;border-radius:2px;margin-right:.25rem}
    /* dark inputs */
    input[type="number"], input[type="range"], select {
      background: rgba(255,255,255,0.03);
      color: #e6eef8;
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: .65rem;
      padding: .5rem;
    }
    input[type="range"]{accent-color: var(--brand);}
    .rounded-2xl { border-radius: 1rem; }
    /* modal */
    .modal-backdrop{ background: rgba(2,6,23,0.55); position: fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:60 }
    .modal { background: linear-gradient(180deg,#071028,#071a32); padding:1.25rem; border-radius: .75rem; border:1px solid rgba(255,255,255,0.04); width: min(780px,96%); max-height:85vh; overflow:auto}
    /* print */
    @media print{
      .no-print{display:none!important}
      #map{height:70vh}
      body{background:white;color:black}
    }
  </style>

</head>
<body class="antialiased">

  <!-- Header -->
  <header class="sticky top-0 z-50 bg-slate-950/80 border-b border-slate-800 no-print">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-blue-500 via-cyan-400 to-indigo-600 grid place-items-center shadow-lg shadow-blue-700/30">
        <span class="font-black text-xl">A</span>
      </div>
      <div>
        <h1 class="text-xl md:text-2xl font-extrabold">Aaria – Growth Forecast Mapping Tool</h1>
        <p class="text-slate-400 text-xs">Blend infra, population, price trends, and connectivity into a single Investment Heatmap.</p>
      </div>

      <div class="ml-auto flex items-center gap-2">
        <button id="btnUserManual" title="User Manual" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm">User Manual</button>
        <button id="btnPrint" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm">Print / Save PDF</button>
        <button id="btnExportPNG" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm">Export PNG</button>
        <button id="btnExportGeo" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-sm">Export Grid GeoJSON</button>
      </div>
    </div>
  </header>

  <!-- Controls -->
  <section class="max-w-7xl mx-auto px-4 py-4 grid lg:grid-cols-3 gap-4">
    <!-- Weights -->
    <div class="rounded-2xl bg-slate-900/60 border border-slate-800 p-4">
      <div class="flex items-start justify-between">
        <h2 class="font-semibold mb-3">Scoring Weights</h2>
        <div class="text-xs text-slate-400">Normalized to 100%</div>
      </div>

      <div class="space-y-3 text-sm">
        <!-- slider template -->
        <div class="grid grid-cols-5 items-center gap-2">
          <label class="col-span-2">Infra proximity</label>
          <input type="range" id="r_infra" min="0" max="40" value="25" data-w="infra" class="col-span-2"/>
          <span id="w_infra" class="text-right">25%</span>
        </div>

        <div class="grid grid-cols-5 items-center gap-2">
          <label class="col-span-2">Population growth</label>
          <input type="range" id="r_pop" min="0" max="40" value="20" data-w="pop" class="col-span-2"/>
          <span id="w_pop" class="text-right">20%</span>
        </div>

        <div class="grid grid-cols-5 items-center gap-2">
          <label class="col-span-2">Price trend (CAGR)</label>
          <input type="range" id="r_price" min="0" max="40" value="25" data-w="price" class="col-span-2"/>
          <span id="w_price" class="text-right">25%</span>
        </div>

        <div class="grid grid-cols-5 items-center gap-2">
          <label class="col-span-2">Transit connectivity</label>
          <input type="range" id="r_transit" min="0" max="40" value="20" data-w="transit" class="col-span-2"/>
          <span id="w_transit" class="text-right">20%</span>
        </div>

        <div class="grid grid-cols-5 items-center gap-2">
          <label class="col-span-2">Zoning / supply</label>
          <input type="range" id="r_supply" min="0" max="40" value="10" data-w="supply" class="col-span-2"/>
          <span id="w_supply" class="text-right">10%</span>
        </div>

        <p class="text-slate-400 text-xs">Adjust sliders — weights auto-normalize. Hover any grid cell on the map to see the detailed breakdown.</p>
      </div>
    </div>

    <!-- Data Uploads -->
    <div class="rounded-2xl bg-slate-900/60 border border-slate-800 p-4">
      <h2 class="font-semibold mb-3">Data Inputs</h2>
      <div class="grid gap-3 text-sm">
        <div class="flex items-center gap-2">
          <label class="px-3 py-2 rounded-xl bg-slate-800/60 hover:bg-slate-700 cursor-pointer">
            Upload CSV
            <input id="csvFile" type="file" accept=".csv" class="hidden"/>
          </label>
          <label class="px-3 py-2 rounded-xl bg-slate-800/60 hover:bg-slate-700 cursor-pointer">
            Upload GeoJSON
            <input id="geoFile" type="file" accept=".json,.geojson" class="hidden"/>
          </label>
          <button id="btnClearData" class="px-3 py-2 rounded-xl bg-rose-600/80 hover:bg-rose-600">Clear Layers</button>
        </div>

        <details class="bg-slate-800/40 rounded-xl p-3">
          <summary class="cursor-pointer font-medium">CSV format</summary>
          <p class="text-slate-400 text-xs mt-2">Columns: <code>lat,lng,value,type</code>. Supported types: <em>infra, pop, price, transit, supply</em>.</p>
        </details>

        <div class="grid sm:grid-cols-2 gap-3">
          <label class="flex items-center gap-2 bg-slate-800/60 rounded-xl px-3 py-2">
            Grid size (m)
            <input id="gridSize" type="number" value="800" min="100" step="50" class="w-full bg-transparent outline-none"/>
          </label>
          <label class="flex items-center gap-2 bg-slate-800/60 rounded-xl px-3 py-2">
            Forecast horizon (yrs)
            <input id="horizon" type="number" value="10" min="1" max="30" class="w-full bg-transparent outline-none"/>
          </label>
        </div>

        <div class="flex items-center gap-2">
          <button id="btnBuildGrid" class="px-3 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 font-medium">Build / Refresh Heatmap</button>
          <button id="btnDemo" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700">Load Demo Data (Kanpur)</button>
        </div>
      </div>
    </div>

    <!-- Map Tools -->
    <div class="rounded-2xl bg-slate-900/60 border border-slate-800 p-4">
      <h2 class="font-semibold mb-3">Map Tools & Projection</h2>
      <div class="grid gap-3 text-sm">
        <label class="flex items-center gap-2 bg-slate-800/60 rounded-xl px-3 py-2">
          Base price (₹/sqft)
          <input id="basePrice" type="number" value="1200" class="w-full bg-transparent outline-none"/>
        </label>

        <label class="flex items-center gap-2 bg-slate-800/60 rounded-xl px-3 py-2">
          Expected CAGR %
          <input id="cagr" type="number" value="10" step="0.1" class="w-full bg-transparent outline-none"/>
        </label>

        <div class="bg-slate-800/40 rounded-xl p-3">
          <p class="text-xs text-slate-400">Projection</p>
          <p id="projOut" class="text-lg font-semibold">₹ — /sqft</p>
        </div>

        <div class="bg-slate-800/50 rounded-xl p-3">
          <p class="text-xs text-slate-400">Estimated ROI in next <span id="yrs">10</span> years:</p>
          <p id="roiOut" class="text-lg font-bold text-emerald-400">—%</p>
        </div>

        <div class="flex items-center gap-2">
          <label class="flex items-center gap-2"><input id="chkHeat" type="checkbox" checked/> Heatmap</label>
          <label class="flex items-center gap-2"><input id="chkChoro" type="checkbox" checked/> Choropleth</label>
          <label class="flex items-center gap-2"><input id="chkPoints" type="checkbox"/> Points</label>
        </div>

        <button id="btnAariaSuggest" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-medium">Aaria Suggests</button>
      </div>
    </div>
  </section>

  <!-- Map -->
  <section class="max-w-7xl mx-auto px-4 pb-6">
    <div id="map"></div>
  </section>

  <!-- Legend -->
  <div class="max-w-7xl mx-auto px-4 pb-8">
    <div class="legend mt-4 inline-flex gap-3 items-center">
      <div><span class="swatch" style="background:#0ea5ff"></span> High</div>
      <div><span class="swatch" style="background:#60a5fa"></span> Medium</div>
      <div><span class="swatch" style="background:#94a3b8"></span> Low</div>
    </div>
  </div>

  <!-- User Manual Modal (hidden by default) -->
  <div id="userManualModal" style="display:none;" class="modal-backdrop no-print" aria-hidden="true">
    <div class="modal">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-xl font-bold">Aaria Growth Forecast Tool — User Manual</h2>
          <p class="text-slate-400 mt-1">Quick guide to make the most of the tool.</p>
        </div>
        <div>
          <button id="closeManual" class="px-3 py-1 rounded-lg bg-slate-800">Close</button>
        </div>
      </div>

      <hr class="my-3 border-slate-800">

      <section class="space-y-3 text-sm">
        <h3 class="font-semibold">1. Load Data</h3>
        <p class="text-slate-300">Upload CSV (lat,lng,value,type) or GeoJSON. Use the Kanpur demo for testing. Points must include a <code>type</code> field among: infra, pop, price, transit, supply.</p>

        <h3 class="font-semibold">2. Set Weights</h3>
        <p class="text-slate-300">Adjust sliders to prioritize factors. The tool auto-normalizes to 100% and recalculates scores.</p>

        <h3 class="font-semibold">3. Build Grid</h3>
        <p class="text-slate-300">Set grid size (meters) and click <strong>Build / Refresh Heatmap</strong>. The map will compute composite scores per cell and render heatmap/chloropleth based on your toggles.</p>

        <h3 class="font-semibold">4. Aaria Suggests</h3>
        <p class="text-slate-300">Click <strong>Aaria Suggests</strong> to highlight top 5 growth zones (by score). Use this to create shortlists for investors.</p>

        <h3 class="font-semibold">5. Projection & ROI</h3>
        <p class="text-slate-300">Update base price and CAGR to view projected price and estimated ROI over the forecast horizon.</p>

        <h3 class="font-semibold">6. Exports</h3>
        <p class="text-slate-300">Use Print/Save PDF for a report (map snapshot + controls hidden in print). Export PNG saves a screenshot; Export GeoJSON saves the current grid with properties.</p>

        <h3 class="font-semibold">7. Draw Areas</h3>
        <p class="text-slate-300">Use the draw tools (top-left on the map) to create AOIs. Exported GeoJSON includes drawn shapes.</p>

        <h3 class="font-semibold">Notes & Tips</h3>
        <ul class="list-disc ml-5 text-slate-300">
          <li>Demo data is synthetic — connect real datasets for production (government open data, property portals, transit project layers).</li>
          <li>Supply is taken as a negative factor when scoring — increase supply weight to penalize oversupplied regions.</li>
        </ul>
      </section>
    </div>
  </div>

  <!-- JS -->
  <script>
  // ====== Globals ======
  const map = L.map('map', { zoomControl:true }).setView([26.45,80.32], 12); // Kanpur default
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Draw control
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);
  const drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems },
    draw: { circle: false, marker: true, polyline:false }
  });
  map.addControl(drawControl);
  map.on(L.Draw.Event.CREATED, function (e) {
    drawnItems.addLayer(e.layer);
  });

  // Layers
  let heatLayer = null;
  let choroLayer = null;
  let pointsLayer = null;
  let gridGeoJSON = null;

  // Data containers
  let uploadedPoints = turf.featureCollection([]); // all point features with properties: {type, value}
  let gridSizeMeters = parseInt(document.getElementById('gridSize').value) || 800;

  // Weights
  const weightIds = ['infra','pop','price','transit','supply'];
  let weights = { infra:25, pop:20, price:25, transit:20, supply:10 };

  function normalizeWeights() {
    // normalize slider values to sum 100 and update UI labels
    let vals = weightIds.map(id => parseInt(document.getElementById('r_' + id).value || 0));
    const sum = vals.reduce((a,b)=>a+b,0) || 1;
    weightIds.forEach((id,i)=>{
      const normalized = Math.round((vals[i]/sum)*100);
      weights[id] = normalized;
      document.getElementById('w_' + id).textContent = normalized + '%';
    });
  }

  // init weights UI
  weightIds.forEach(id=>{
    document.getElementById('r_' + id).addEventListener('input', ()=> {
      normalizeWeights();
    });
  });
  normalizeWeights();

  // update projection & ROI
  function updateProjection() {
    const base = Number(document.getElementById('basePrice').value) || 0;
    const cagr = (Number(document.getElementById('cagr').value) || 0) / 100;
    const yrs = Number(document.getElementById('horizon').value) || 10;
    const future = base * Math.pow(1 + cagr, yrs);
    const roi = base ? (((future - base)/base)*100).toFixed(1) : '—';
    document.getElementById('projOut').textContent = `₹${future.toFixed(0)}/sqft`;
    document.getElementById('roiOut').textContent = `${roi}%`;
    document.getElementById('yrs').textContent = yrs;
  }
  ['basePrice','cagr','horizon'].forEach(id => document.getElementById(id).addEventListener('input', updateProjection));
  updateProjection();

  // ===== CSV parser (simple) =====
  function parseCSV(text) {
    const rows = text.trim().split(/\r?\n/).map(r => r.split(','));
    // header detection
    const headers = rows[0].map(h=>h.trim().toLowerCase());
    const data = rows.slice(1).map(cols=>{
      const obj = {};
      headers.forEach((h,i)=> obj[h] = cols[i] ? cols[i].trim() : '');
      return obj;
    });
    return data;
  }

  // Upload CSV
  document.getElementById('csvFile').addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      try {
        const data = parseCSV(evt.target.result);
        const points = data.map(d=>{
          const lat = parseFloat(d.lat || d.latitude || d.lat_deg);
          const lng = parseFloat(d.lng || d.lon || d.longitude);
          const value = Number(d.value || d.score || d.v || 1);
          const type = (d.type || 'infra').trim().toLowerCase();
          return turf.point([lng,lat], { type, value });
        }).filter(p => p.geometry && !isNaN(p.geometry.coordinates[0]));
        uploadedPoints = turf.featureCollection(points);
        addPointsLayer();
      } catch(err) {
        alert('CSV parse error: ' + err.message);
      }
    }
    reader.readAsText(file);
  });

  // Upload GeoJSON (assume points)
  document.getElementById('geoFile').addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      try {
        const geo = JSON.parse(evt.target.result);
        const pts = [];
        turf.featureEach(geo, f => {
          if(f.geometry && f.geometry.type === 'Point') {
            // expected props: type, value
            pts.push(turf.point(f.geometry.coordinates, { type: f.properties.type || 'infra', value: f.properties.value || 1 }));
          }
        });
        uploadedPoints = turf.featureCollection(pts);
        addPointsLayer();
      } catch(err) {
        alert('GeoJSON parse error: ' + err.message);
      }
    }
    reader.readAsText(file);
  });

  // Clear layers
  document.getElementById('btnClearData').addEventListener('click', ()=>{
    uploadedPoints = turf.featureCollection([]);
    if(pointsLayer) { map.removeLayer(pointsLayer); pointsLayer = null; }
    if(heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }
    if(choroLayer) { map.removeLayer(choroLayer); choroLayer = null; }
    if(gridGeoJSON) { gridGeoJSON = null; }
    drawnItems.clearLayers();
  });

  // Add points layer
  function addPointsLayer(){
    if(pointsLayer) map.removeLayer(pointsLayer);
    const markers = uploadedPoints.features.map(f=>{
      const coords = f.geometry.coordinates;
      const type = f.properties.type || 'infra';
      const v = f.properties.value || 1;
      return L.circleMarker([coords[1],coords[0]], {
        radius: 5,
        weight: 0.6,
        fillOpacity: 0.9
      }).bindTooltip(`${type.toUpperCase()}: ${v}`);
    });
    pointsLayer = L.layerGroup(markers);
    if(document.getElementById('chkPoints').checked) pointsLayer.addTo(map);
  }

  document.getElementById('chkPoints').addEventListener('change', (e)=>{
    if(pointsLayer) {
      if(e.target.checked) pointsLayer.addTo(map);
      else map.removeLayer(pointsLayer);
    }
  });

  // ===== Build Grid & Scoring =====
  document.getElementById('btnBuildGrid').addEventListener('click', ()=> {
    gridSizeMeters = Number(document.getElementById('gridSize').value) || 800;
    buildGridAndScore();
  });

  // Demo data generator for Kanpur (synthetic)
  document.getElementById('btnDemo').addEventListener('click', ()=>{
    loadKanpurDemo();
  });

  function loadKanpurDemo(){
    // rough bounding box around Kanpur
    const bbox = [80.20,26.35,80.45,26.55]; // [minX,minY,maxX,maxY] in lon/lat
    const types = ['infra','pop','price','transit','supply'];
    const pts = [];
    for(let i=0;i<220;i++){
      const lon = Math.random()*(bbox[2]-bbox[0]) + bbox[0];
      const lat = Math.random()*(bbox[3]-bbox[1]) + bbox[1];
      // assign type randomly but bias certain areas
      const t = types[Math.floor(Math.random()*types.length)];
      // values: infra/transit higher at center, price/pop show gradient
      const cx = 80.32, cy = 26.45;
      const d = Math.sqrt(Math.pow(lon-cx,2)+Math.pow(lat-cy,2));
      let val = Math.round( (Math.max(0,1 - d*6) * (Math.random()*50 + 50)) );
      if(t === 'supply') val = Math.round(Math.random()*80); // supply random
      pts.push(turf.point([lon,lat], { type: t, value: val }));
    }
    uploadedPoints = turf.featureCollection(pts);
    addPointsLayer();
    map.fitBounds([[bbox[1],bbox[0]],[bbox[3],bbox[2]]]);
    buildGridAndScore();
  }

  // compute composite score for a cell: average values for each type inside polygon
  function computeCellScore(cell) {
    // for each factor, gather points within polygon and compute average value (0-100)
    const props = { infra:0, pop:0, price:0, transit:0, supply:0 };
    weightIds.forEach(k => props[k] = 0);
    const totals = { infra:0, pop:0, price:0, transit:0, supply:0 };
    const counts = { infra:0, pop:0, price:0, transit:0, supply:0 };

    if (uploadedPoints.features.length === 0) {
      // fallback random mild score when no data
      const rand = Math.round(Math.random()*40 + 40);
      return { score: rand, breakdown: props };
    }

    // turf.pointsWithinPolygon
    const ptsInside = turf.pointsWithinPolygon(uploadedPoints, cell);
    ptsInside.features.forEach(p => {
      const t = (p.properties.type || 'infra').toLowerCase();
      const v = Number(p.properties.value || 0);
      if(t in totals) { totals[t] += v; counts[t] += 1; }
    });

    weightIds.forEach(k=>{
      if(counts[k] > 0) props[k] = totals[k] / counts[k];
      else props[k] = 0;
    });

    // normalize each field to 0-100 range by simple heuristic:
    // assume values are around 0-100; clamp
    weightIds.forEach(k => {
      props[k] = Math.max(0, Math.min(100, props[k]));
    });

    // supply is considered negative (more supply lowers score). We'll invert supply.
    const wInfra = weights.infra/100, wPop = weights.pop/100, wPrice = weights.price/100, wTransit = weights.transit/100, wSupply = weights.supply/100;
    const score = props.infra*wInfra + props.pop*wPop + props.price*wPrice + props.transit*wTransit + (100 - props.supply)*wSupply;
    return { score: Math.round(score), breakdown: props };
  }

  function buildGridAndScore(){
    // remove layers
    if(choroLayer) { map.removeLayer(choroLayer); choroLayer = null; }
    if(heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }
    if(gridGeoJSON) gridGeoJSON = null;

    // create square grid for current map bounds
    const bounds = map.getBounds();
    const bbox = [bounds.getWest(), bounds.getSouth(), bounds.getEast(), bounds.getNorth()];
    // convert grid size meters to kilometers for turf.squareGrid units=kilometers
    const cellSizeKm = gridSizeMeters / 1000;
    const options = { units: 'kilometers' };
    const grid = turf.squareGrid(bbox, cellSizeKm, options);
    // compute score for each polygon
    grid.features.forEach((cell, idx) => {
      const result = computeCellScore(cell);
      cell.properties.score = result.score;
      cell.properties.breakdown = result.breakdown;
    });

    gridGeoJSON = grid;

    // create choropleth (color by score)
    choroLayer = L.geoJSON(grid, {
      style: feature => {
        const s = feature.properties.score || 0;
        const color = s > 75 ? '#0ea5ff' : (s > 50 ? '#60a5fa' : '#94a3b8');
        return { color: color, weight: 1, fillColor: color, fillOpacity: 0.35 };
      },
      onEachFeature: (feature, layer) => {
        const s = feature.properties.score || 0;
        const breakdown = feature.properties.breakdown || {};
        layer.on('mouseover', (e)=>{
          const html = `<div style="line-height:1.1">
            <strong>Score: ${s}/100</strong><br/>
            Infra: ${Math.round(breakdown.infra)} | Pop: ${Math.round(breakdown.pop)} | Price: ${Math.round(breakdown.price)}<br/>
            Transit: ${Math.round(breakdown.transit)} | Supply: ${Math.round(breakdown.supply)}
          </div>`;
          layer.bindTooltip(html, { sticky:true }).openTooltip();
        });
        layer.on('mouseout', ()=> layer.closeTooltip());
      }
    });

    // heat layer based on centroids & score
    const heatPoints = grid.features.map(cell=>{
      const centroid = turf.centroid(cell).geometry.coordinates;
      const intensity = (cell.properties.score || 0) / 100;
      return [centroid[1], centroid[0], intensity];
    });

    heatLayer = L.heatLayer(heatPoints, { radius: 25, blur: 30, maxZoom: 13 });

    // add to map based on toggles
    if(document.getElementById('chkChoro').checked) choroLayer.addTo(map);
    if(document.getElementById('chkHeat').checked) heatLayer.addTo(map);
    if(document.getElementById('chkPoints').checked && pointsLayer) pointsLayer.addTo(map);

    // fit to grid
    const gridBounds = choroLayer.getBounds();
    if(gridBounds.isValid()) map.fitBounds(gridBounds);

    updateProjection();
  }

  document.getElementById('chkChoro').addEventListener('change', (e)=>{
    if(choroLayer) {
      if(e.target.checked) choroLayer.addTo(map);
      else map.removeLayer(choroLayer);
    }
  });
  document.getElementById('chkHeat').addEventListener('change', (e)=>{
    if(heatLayer) {
      if(e.target.checked) heatLayer.addTo(map);
      else map.removeLayer(heatLayer);
    }
  });

  // Aaria Suggests - top N zones
  document.getElementById('btnAariaSuggest').addEventListener('click', ()=>{
    if(!gridGeoJSON) { alert('Build the grid first'); return; }
    // pick top 5 by score
    const sorted = gridGeoJSON.features.slice().sort((a,b)=> (b.properties.score||0) - (a.properties.score||0));
    const top = sorted.slice(0,5);
    // clear previous highlight
    if(window._aariaSuggestLayer) map.removeLayer(window._aariaSuggestLayer);
    window._aariaSuggestLayer = L.geoJSON(top, {
      style: { color: '#10b981', weight: 2, fillOpacity: 0.15 },
      onEachFeature: (f, l) => l.bindTooltip(`Top zone — Score: ${f.properties.score}`)
    }).addTo(map);
    // zoom to top zone
    if(top.length) map.fitBounds(window._aariaSuggestLayer.getBounds(), { maxZoom: 14 });
  });

  // Export GeoJSON
  document.getElementById('btnExportGeo').addEventListener('click', ()=>{
    if(!gridGeoJSON) { alert('No grid to export. Build the grid first.'); return; }
    // include drawn AOIs as features as well
    const drawn = drawnItems.toGeoJSON();
    const out = {
      type: "FeatureCollection",
      features: (gridGeoJSON.features || []).concat(drawn.features || [])
    };
    const blob = new Blob([JSON.stringify(out, null, 2)], {type: "application/json"});
    saveAs(blob, `aaria_grid_${Date.now()}.geojson`);
  });

  // Export PNG via html2canvas (map area)
  document.getElementById('btnExportPNG').addEventListener('click', async ()=>{
    const el = document.getElementById('map');
    // temporarily show a small watermark to indicate Aaria brand
    const watermark = document.createElement('div');
    watermark.style.position = 'absolute';
    watermark.style.right = '12px';
    watermark.style.bottom = '12px';
    watermark.style.zIndex = 99999;
    watermark.style.opacity = '0.9';
    watermark.style.padding = '6px 10px';
    watermark.style.borderRadius = '8px';
    watermark.style.background = 'rgba(3,7,18,0.6)';
    watermark.style.color = '#cfe9ff';
    watermark.innerText = 'Aaria Growth Map';
    el.appendChild(watermark);

    try{
      const canvas = await html2canvas(el, { scale: 2 });
      canvas.toBlob((blob)=>{
        saveAs(blob, `aaria_map_${Date.now()}.png`);
        watermark.remove();
      });
    } catch(err) {
      watermark.remove();
      alert('PNG export failed: ' + err.message);
    }
  });

  // Print / Save PDF (using print)
  document.getElementById('btnPrint').addEventListener('click', ()=>{
    window.print();
  });

  // User Manual modal toggles
  document.getElementById('btnUserManual').addEventListener('click', ()=>{
    document.getElementById('userManualModal').style.display = 'flex';
  });
  document.getElementById('closeManual').addEventListener('click', ()=>{
    document.getElementById('userManualModal').style.display = 'none';
  });
  // close modal on backdrop click
  document.getElementById('userManualModal').addEventListener('click', (e)=>{
    if(e.target === document.getElementById('userManualModal')) document.getElementById('userManualModal').style.display = 'none';
  });

  // initial demo load to give user immediate visual
  loadKanpurDemo();

  </script>
</body>
</html>
